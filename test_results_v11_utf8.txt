
> momentum-platform@9.6.0 test:all
> npm --prefix functions run test -- --runInBand --detectOpenHandles


> momentum-functions@1.0.0 test
> jest --config ./jest.config.js --runInBand --detectOpenHandles

npm : 
ts-jest[ts-jest-transformer] 
(WARN) Define `ts-jest` 
config under `globals` is 
deprecated. Please do
No linha:1 caractere:1
+ npm run test:all > 
test_results_v11.txt 2>&1
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~
    + CategoryInfo          : 
    NotSpecified: (ts-jest[t  
  s-jest...ated. Please do:   
 String) [], RemoteExcepti    
on
    + FullyQualifiedErrorId : 
    NativeCommandError
 
transform: {
    <transform_regex>: 
['ts-jest', { /* ts-jest 
config goes here in Jest */ 
}],
},
See more at https://kulshekhar
.github.io/ts-jest/docs/gettin
g-started/presets#advanced
FAIL 
tests/cfo-ai-report.test.ts 
(16.673 s)
  ÔùÅ Console

    console.log
      [TEST_DEBUG] 
status/body 502 {
        error: 
'makeCollection is not a 
function',
        traceId: '00051603-ac0
7-4fdd-8edb-7d2ce1a97677'
      }

      at debugIfNotOk (tests/h
elpers/testApp.ts:16:13)

    console.log
      [TEST_DEBUG] 
status/body 502 {
        error: 
'makeCollection is not a 
function',
        traceId: '73d53216-f30
d-4c23-88d9-d569cb3feca5'
      }

      at debugIfNotOk (tests/h
elpers/testApp.ts:16:13)

    console.log
      [TEST_DEBUG] 
status/body 403 {
        ok: false,
        error: 'Feature not 
available in your plan.',
        feature: 
'cfo_premium',
        plan: 'free',
        code: 
'UPGRADE_REQUIRED'
      }

      at debugIfNotOk (tests/h
elpers/testApp.ts:16:13)

  ÔùÅ POST /api/cfo/ai-report 
ÔÇ║ executa AI report com 
provider openai

    expect(received).toBe(expe
cted) // Object.is equality

    Expected: 200
    Received: 502

    [0m [90m 58 |[39m     
[36mawait[39m 
debugIfNotOk(res)[33m;[39m
     [90m 59 |[39m
    [31m[1m>[22m[39m[90m 
60 |[39m     expect(res[33m.
[39mstatus)[33m.[39mtoBe([
35m200[39m)[33m;[39m
     [90m    |[39m          
              
[31m[1m^[22m[39m
     [90m 61 |[39m     expec
t(res[33m.[39mbody[33m.[39
mreport)[33m.[39mtoBe([32m"
mock-report"[39m)[33m;[39m
     [90m 62 |[39m     
expect((generateCfoAiReport 
[36mas[39m any)[33m.[39mmo
ck[33m.[39mcalls[33m.[39ml
ength)[33m.[39mtoBeGreaterTh
an([35m0[39m)[33m;[39m
     [90m 63 |[39m     expec
t(mockAdd)[33m.[39mtoHaveBee
nCalled()[33m;[39m [90m// 
usage log[39m[0m

      at Object.<anonymous> (t
ests/cfo-ai-report.test.ts:60:
24)

  ÔùÅ POST /api/cfo/ai-report 
ÔÇ║ executa AI report com 
provider gemini

    expect(received).toBe(expe
cted) // Object.is equality

    Expected: 200
    Received: 502

    [0m [90m 73 |[39m     
[36mawait[39m 
debugIfNotOk(res)[33m;[39m
     [90m 74 |[39m
    [31m[1m>[22m[39m[90m 
75 |[39m     expect(res[33m.
[39mstatus)[33m.[39mtoBe([
35m200[39m)[33m;[39m
     [90m    |[39m          
              
[31m[1m^[22m[39m
     [90m 76 |[39m     expec
t(res[33m.[39mbody[33m.[39
mreport)[33m.[39mtoBe([32m"
mock-report"[39m)[33m;[39m
     [90m 77 |[39m     expec
t(mockAdd)[33m.[39mtoHaveBee
nCalled()[33m;[39m
     [90m 78 |[39m   
})[33m;[39m[0m

      at Object.<anonymous> (t
ests/cfo-ai-report.test.ts:75:
24)

PASS 
tests/public-signup.test.ts
  ÔùÅ Console

    console.log
      {"level":"info","message
":"Public signup created new t
enant","tenantId":"mock-id-1",
"uid":"mock-user","email":"moc
k@example.com","mode":"new"}

      at Object.info 
(src/utils/logger.ts:48:13)

PASS tests/cfo-summary.test.ts
PASS tests/ai.test.ts
PASS tests/compliance.test.ts
  ÔùÅ Console

    console.log
      {"level":"info","message
":"Consent accepted by test-ui
d","traceId":"0120d066-519c-45
05-9674-133aa5e58ed4"}

      at Object.info 
(src/utils/logger.ts:48:13)

PASS 
tests/billing-usage.test.ts
PASS tests/billing.test.ts
PASS tests/withTenant-legacy-s
tatus.test.ts
  ÔùÅ Console

    console.warn
      [TENANT_MEMBER_MISSING_S
TATUS] { tenantId: 't1', uid: 
'u1', traceId: null }

    [0m [90m 168 |[39m
     [90m 169 |[39m     
[36mif[39m 
([33m![39mmemberStatus) {
    [31m[1m>[22m[39m[90m 
170 |[39m       console[33m.
[39mwarn([32m"[TENANT_MEMBER
_MISSING_STATUS]"[39m[33m,[
39m {
     [90m     |[39m         
      [31m[1m^[22m[39m
     [90m 171 |[39m         
tenantId[33m,[39m
     [90m 172 |[39m         
uid[33m:[39m req[33m.[39mu
ser[33m?[39m[33m.[39muid 
[33m||[39m 
[36mnull[39m[33m,[39m
     [90m 173 |[39m         
traceId[33m:[39m (req 
[36mas[39m 
any)[33m.[39mtraceId 
[33m||[39m 
[36mnull[39m[33m,[39m[0m

      at withTenant (src/middl
eware/withTenant.ts:170:15)

PASS tests/rateLimit.test.ts
  ÔùÅ Console

    console.error
      {"level":"error","type":
"rate_limit_error","err":"Erro
r: Firestore unavailable"}

    [0m [90m 151 |[39m     
  [36mreturn[39m 
next()[33m;[39m
     [90m 152 |[39m     } 
[36mcatch[39m (e) {
    [31m[1m>[22m[39m[90m 
153 |[39m       console[33m.
[39merror([33mJSON[39m[33m
.[39mstringify({ 
level[33m:[39m 
[32m"error"[39m[33m,[39m 
type[33m:[39m [32m"rate_lim
it_error"[39m[33m,[39m 
err[33m:[39m 
[33mString[39m(e) 
}))[33m;[39m
     [90m     |[39m         
      [31m[1m^[22m[39m
     [90m 154 |[39m
     [90m 155 |[39m       
[90m// FALLBACK 
STRATEGY:[39m
     [90m 156 |[39m       
[90m// Check if this is a 
critical route that should 
fail-closed[39m[0m

      at rateLimit (src/middle
ware/rateLimit.ts:153:15)
      at Object.<anonymous> 
(tests/rateLimit.test.ts:72:9)

    console.warn
      {"level":"warn","type":"
rate_limit_fail_closed","path"
:"/api/billing/charge","reason
":"Firestore unavailable for 
critical route"}

    [0m [90m 159 |[39m     
  [36mif[39m (isCritical) {
     [90m 160 |[39m         
[90m// FAIL-CLOSED: Deny 
request on critical routes 
when Firestore fails[39m
    [31m[1m>[22m[39m[90m 
161 |[39m         console[33
m.[39mwarn([33mJSON[39m[33
m.[39mstringify({
     [90m     |[39m         
        [31m[1m^[22m[39m
     [90m 162 |[39m         
  level[33m:[39m 
[32m"warn"[39m[33m,[39m
     [90m 163 |[39m         
  type[33m:[39m [32m"rate_l
imit_fail_closed"[39m[33m,[
39m
     [90m 164 |[39m         
  path[33m:[39m req[33m.[3
9mpath[33m,[39m[0m

      at rateLimit (src/middle
ware/rateLimit.ts:161:17)
      at Object.<anonymous> 
(tests/rateLimit.test.ts:72:9)

    console.error
      {"level":"error","type":
"rate_limit_error","err":"Erro
r: Firestore unavailable"}

    [0m [90m 151 |[39m     
  [36mreturn[39m 
next()[33m;[39m
     [90m 152 |[39m     } 
[36mcatch[39m (e) {
    [31m[1m>[22m[39m[90m 
153 |[39m       console[33m.
[39merror([33mJSON[39m[33m
.[39mstringify({ 
level[33m:[39m 
[32m"error"[39m[33m,[39m 
type[33m:[39m [32m"rate_lim
it_error"[39m[33m,[39m 
err[33m:[39m 
[33mString[39m(e) 
}))[33m;[39m
     [90m     |[39m         
      [31m[1m^[22m[39m
     [90m 154 |[39m
     [90m 155 |[39m       
[90m// FALLBACK 
STRATEGY:[39m
     [90m 156 |[39m       
[90m// Check if this is a 
critical route that should 
fail-closed[39m[0m

      at rateLimit (src/middle
ware/rateLimit.ts:153:15)
      at Object.<anonymous> 
(tests/rateLimit.test.ts:90:9)

    console.info
      {"level":"info","type":"
rate_limit_memory_fallback_ok"
,"path":"/api/public/status"}

      at rateLimit (src/middle
ware/rateLimit.ts:198:17)

PASS tests/utils.test.ts

Test Suites: 1 failed, 9 
passed, 10 total
Tests:       2 failed, 12 
passed, 14 total
Snapshots:   0 total
Time:        21.005 s
Ran all test suites.
