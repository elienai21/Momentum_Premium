rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================
    // üß© FUN√á√ïES AUXILIARES (DRY)
    // =====================================================
    function isAuthenticated() {
      return request.auth != null && request.auth.uid != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
        (request.auth.token.roles.admin == true ||
         request.auth.token.isAdmin == true ||
         request.auth.token.admin == true);
    }

    function isSupportAgent() {
      return isAuthenticated() &&
        (request.auth.token.roles.support == true ||
         request.auth.token.supportAgent == true);
    }

    // Calls feitas via Admin SDK / Service Account (Cloud Functions backend)
    function isServerRequest() {
      return request.auth != null &&
        (
          (
            request.auth.token.firebase != null &&
            request.auth.token.firebase.sign_in_provider == "service_account"
          ) ||
          (
            request.auth.token.email != null &&
            request.auth.token.email.matches(".*gserviceaccount\\.com$")
          )
        );
    }

    // =====================================================
    // üîê TENANTS ‚Äî Isolamento organizacional
    // =====================================================
    match /tenants/{tenantId} {
      allow read, write: if isAuthenticated() &&
        request.auth.token.tenantId == tenantId;
    }

    // =====================================================
    // üí≥ TRANSA√á√ïES FINANCEIRAS (somente servidor/admin)
    // =====================================================
    match /transactions/{docId} {
      allow read, write: if isServerRequest() || isAdmin();
    }

    // =====================================================
    // üßæ CONTAS / CONFIGURA√á√ïES DE COBRAN√áA
    // =====================================================
    match /tenants/{tenantId}/accounts/{docId} {
      allow read, write: if isServerRequest() ||
        (isAuthenticated() && request.auth.token.tenantId == tenantId && isAdmin());
    }

    // =====================================================
    // üìä LOGS DE USO (somente servidor/admin)
    // =====================================================
    match /usage_logs/{docId} {
      allow read, write: if isServerRequest() || isAdmin();
    }

    // =====================================================
    // ‚úÖ PRIVACY CONSENTS (por usu√°rio)
    // =====================================================
    match /privacy_consents/{uid} {
      allow read: if isAuthenticated() && request.auth.uid == uid;
      allow write: if isAuthenticated() && request.auth.uid == uid;
    }

    // =====================================================
    // üö® ALERTAS GERAIS
    // =====================================================
    match /alerts/{docId} {
      allow read: if isAuthenticated() && isAdmin();
      allow write: if false;
    }

    // =====================================================
    // üö® ALERTAS POR TENANT
    // =====================================================
    match /tenants/{tenantId}/alerts/{aid} {
      allow read, update, create: if isAuthenticated() &&
        request.auth.token.tenantId == tenantId;
      allow delete: if false;
    }

    // =====================================================
    // üßë‚Äçüíª SUPPORT SESSIONS (por tenant + usu√°rio)
    // =====================================================
    match /tenants/{tenantId}/support_sessions/{sid} {
      allow create: if isAuthenticated() &&
        request.auth.token.tenantId == tenantId &&
        request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() &&
        request.auth.token.tenantId == tenantId &&
        resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    match /tenants/{tenantId}/support_feedback/{fid} {
      allow create: if isAuthenticated() &&
        request.auth.token.tenantId == tenantId &&
        request.resource.data.userId == request.auth.uid;
      allow read, update, delete: if false;
    }

    // =====================================================
    // üè¢ REAL ESTATE ‚Äì VIS√ÉO MENSAL POR IM√ìVEL
    // =====================================================
    match /tenants/{tenantId}/realestate-monthly/{docId} {
      // üîê Vers√£o DEV: qualquer usu√°rio autenticado pode ler
      // (seus usu√°rios ainda n√£o t√™m tenantId/roles configurados)
      // üîê Acesso restrito ao tenant correspondente
      allow read: if isAuthenticated() && request.auth.token.tenantId == tenantId;

      // Se quiser algo mais r√≠gido depois que tiver claims:
      // allow read: if isAuthenticated()
      //             && request.auth.token.tenantId == tenantId;

      allow write: if false; // dashboard √© s√≥ leitura
    }

    // =====================================================
    // üìà DADOS DE MERCADO (P√∫blico para usu√°rios logados)
    // =====================================================
    match /market_indicators/{docId} {
      allow read: if isAuthenticated();
      allow write: if false; // somente via backend/admin
    }

    match /market_news/{docId} {
      allow read: if isAuthenticated();
      allow write: if false; // somente via backend/admin
    }

    // =====================================================
    // ‚ùå DEFAULT DENY (deixa SEMPRE POR √öLTIMO)
    // =====================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
