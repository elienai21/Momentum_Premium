
> momentum-platform@9.6.0 test:all
> npm --prefix functions run test -- --runInBand --detectOpenHandles


> momentum-functions@1.0.0 test
> jest --config ./jest.config.js --runInBand --detectOpenHandles

npm : 
ts-jest[ts-jest-transformer] 
(WARN) Define `ts-jest` config 
under `globals` is deprecated. 
Please do
No linha:1 caractere:1
+ npm run test:all > 
test_results_v6.txt 2>&1
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~
    + CategoryInfo          : Not 
   Specified: (ts-jest[ts-jest..  
  .ated. Please do:String) [],    
 RemoteException
    + FullyQualifiedErrorId : Nat 
   iveCommandError
 
transform: {
    <transform_regex>: 
['ts-jest', { /* ts-jest config 
goes here in Jest */ }],
},
See more at https://kulshekhar.git
hub.io/ts-jest/docs/getting-starte
d/presets#advanced
FAIL tests/public-signup.test.ts
  ÔùÅ Test suite failed to run

    [96mtests/public-signup.test.
ts[0m:[93m30[0m:[93m26[0m - 
[91merror[0m[90m TS2339: 
[0mProperty 'role' does not 
exist on type '{}'.

    [7m30[0m     expect(memberPa
yload.role).toBe("admin");
    [7m  [0m [91m              
           ~~~~[0m
    [96mtests/public-signup.test.
ts[0m:[93m31[0m:[93m26[0m - 
[91merror[0m[90m TS2339: 
[0mProperty 'status' does not 
exist on type '{}'.

    [7m31[0m     expect(memberPa
yload.status).toBe("active");
    [7m  [0m [91m              
           ~~~~~~[0m
    [96mtests/public-signup.test.
ts[0m:[93m32[0m:[93m26[0m - 
[91merror[0m[90m TS2339: 
[0mProperty 'email' does not 
exist on type '{}'.

    [7m32[0m     expect(memberPa
yload.email).toBeTruthy();
    [7m  [0m [91m              
           ~~~~~[0m
    [96mtests/public-signup.test.
ts[0m:[93m33[0m:[93m26[0m - 
[91merror[0m[90m TS2339: 
[0mProperty 'joinedAt' does not 
exist on type '{}'.

    [7m33[0m     expect(memberPa
yload.joinedAt).toBeTruthy();
    [7m  [0m [91m              
           ~~~~~~~~[0m

FAIL tests/billing.test.ts
  ÔùÅ Test suite failed to run

    [96mtests/billing.test.ts[0m
:[93m9[0m:[93m43[0m - 
[91merror[0m[90m TS2345: 
[0mArgument of type '{ id: 
string; }' is not assignable to 
parameter of type 'never'.

    [7m9[0m       create: 
jest.fn().mockResolvedValue({ id: 
"ur_123" }),
    [7m [0m [91m               
                           
~~~~~~~~~~~~~~~~[0m

PASS tests/compliance.test.ts
  ÔùÅ Console

    console.log
      {"level":"info","message":"C
onsent accepted by test-uid","trac
eId":"30c87cfd-059c-4c64-8cbe-516f
408cdec9"}

      at Object.info 
(src/utils/logger.ts:48:13)

PASS tests/ai.test.ts
PASS tests/cfo-summary.test.ts
PASS tests/withTenant-legacy-statu
s.test.ts
  ÔùÅ Console

    console.warn
      
[TENANT_MEMBER_MISSING_STATUS] { 
tenantId: 't1', uid: 'u1', 
traceId: null }

    [0m [90m 168 |[39m
     [90m 169 |[39m     
[36mif[39m 
([33m![39mmemberStatus) {
    [31m[1m>[22m[39m[90m 170 
|[39m       console[33m.[39mwar
n([32m"[TENANT_MEMBER_MISSING_STA
TUS]"[39m[33m,[39m {
     [90m     |[39m             
  [31m[1m^[22m[39m
     [90m 171 |[39m         
tenantId[33m,[39m
     [90m 172 |[39m         
uid[33m:[39m req[33m.[39muser
[33m?[39m[33m.[39muid 
[33m||[39m 
[36mnull[39m[33m,[39m
     [90m 173 |[39m         
traceId[33m:[39m (req 
[36mas[39m 
any)[33m.[39mtraceId 
[33m||[39m 
[36mnull[39m[33m,[39m[0m

      at withTenant (src/middlewar
e/withTenant.ts:170:15)

PASS tests/rateLimit.test.ts
  ÔùÅ Console

    console.error
      {"level":"error","type":"rat
e_limit_error","err":"Error: 
Firestore unavailable"}

    [0m [90m 151 |[39m       
[36mreturn[39m next()[33m;[39m
     [90m 152 |[39m     } 
[36mcatch[39m (e) {
    [31m[1m>[22m[39m[90m 153 
|[39m       console[33m.[39merr
or([33mJSON[39m[33m.[39mstring
ify({ level[33m:[39m 
[32m"error"[39m[33m,[39m 
type[33m:[39m [32m"rate_limit_e
rror"[39m[33m,[39m 
err[33m:[39m 
[33mString[39m(e) }))[33m;[39m
     [90m     |[39m             
  [31m[1m^[22m[39m
     [90m 154 |[39m
     [90m 155 |[39m       
[90m// FALLBACK STRATEGY:[39m
     [90m 156 |[39m       
[90m// Check if this is a 
critical route that should 
fail-closed[39m[0m

      at rateLimit (src/middleware
/rateLimit.ts:153:15)
      at Object.<anonymous> 
(tests/rateLimit.test.ts:72:9)

    console.warn
      {"level":"warn","type":"rate
_limit_fail_closed","path":"/api/b
illing/charge","reason":"Firestore
 unavailable for critical route"}

    [0m [90m 159 |[39m       
[36mif[39m (isCritical) {
     [90m 160 |[39m         
[90m// FAIL-CLOSED: Deny request 
on critical routes when Firestore 
fails[39m
    [31m[1m>[22m[39m[90m 161 
|[39m         console[33m.[39mw
arn([33mJSON[39m[33m.[39mstrin
gify({
     [90m     |[39m             
    [31m[1m^[22m[39m
     [90m 162 |[39m           
level[33m:[39m 
[32m"warn"[39m[33m,[39m
     [90m 163 |[39m           
type[33m:[39m [32m"rate_limit_f
ail_closed"[39m[33m,[39m
     [90m 164 |[39m           
path[33m:[39m 
req[33m.[39mpath[33m,[39m[0m

      at rateLimit (src/middleware
/rateLimit.ts:161:17)
      at Object.<anonymous> 
(tests/rateLimit.test.ts:72:9)

    console.error
      {"level":"error","type":"rat
e_limit_error","err":"Error: 
Firestore unavailable"}

    [0m [90m 151 |[39m       
[36mreturn[39m next()[33m;[39m
     [90m 152 |[39m     } 
[36mcatch[39m (e) {
    [31m[1m>[22m[39m[90m 153 
|[39m       console[33m.[39merr
or([33mJSON[39m[33m.[39mstring
ify({ level[33m:[39m 
[32m"error"[39m[33m,[39m 
type[33m:[39m [32m"rate_limit_e
rror"[39m[33m,[39m 
err[33m:[39m 
[33mString[39m(e) }))[33m;[39m
     [90m     |[39m             
  [31m[1m^[22m[39m
     [90m 154 |[39m
     [90m 155 |[39m       
[90m// FALLBACK STRATEGY:[39m
     [90m 156 |[39m       
[90m// Check if this is a 
critical route that should 
fail-closed[39m[0m

      at rateLimit (src/middleware
/rateLimit.ts:153:15)
      at Object.<anonymous> 
(tests/rateLimit.test.ts:90:9)

    console.info
      {"level":"info","type":"rate
_limit_memory_fallback_ok","path":
"/api/public/status"}

      at rateLimit (src/middleware
/rateLimit.ts:198:17)

PASS tests/utils.test.ts
FAIL tests/cfo-ai-report.test.ts
  ÔùÅ Console

    console.log
      [TEST_DEBUG] status/body 
502 {
        error: 'path.split is not 
a function',
        traceId: '64be6574-0615-47
3e-9b90-858e35d979b0'
      }

      at debugIfNotOk 
(tests/helpers/testApp.ts:16:13)

    console.log
      [TEST_DEBUG] status/body 
502 {
        error: 'path.split is not 
a function',
        traceId: '2adc6211-9851-47
d7-8745-a500374e5079'
      }

      at debugIfNotOk 
(tests/helpers/testApp.ts:16:13)

    console.log
      [TEST_DEBUG] status/body 
403 {
        ok: false,
        error: 'Feature not 
available in your plan.',
        feature: 'cfo_premium',
        plan: 'free',
        code: 'UPGRADE_REQUIRED'
      }

      at debugIfNotOk 
(tests/helpers/testApp.ts:16:13)

  ÔùÅ POST /api/cfo/ai-report ÔÇ║ 
executa AI report com provider 
openai

    
expect(received).toBe(expected) 
// Object.is equality

    Expected: 200
    Received: 502

    [0m [90m 54 |[39m     
[36mawait[39m 
debugIfNotOk(res)[33m;[39m
     [90m 55 |[39m
    [31m[1m>[22m[39m[90m 56 
|[39m     expect(res[33m.[39mst
atus)[33m.[39mtoBe([35m200[39m
)[33m;[39m
     [90m    |[39m              
          [31m[1m^[22m[39m
     [90m 57 |[39m     expect(re
s[33m.[39mbody[33m.[39mreport)
[33m.[39mtoBe([32m"mock-report"
[39m)[33m;[39m
     [90m 58 |[39m     
expect((generateCfoAiReport 
[36mas[39m any)[33m.[39mmock[
33m.[39mcalls[33m.[39mlength)[
33m.[39mtoBeGreaterThan([35m0[3
9m)[33m;[39m
     [90m 59 |[39m     expect(mo
ckAdd)[33m.[39mtoHaveBeenCalled(
)[33m;[39m [90m// usage 
log[39m[0m

      at Object.<anonymous> (tests
/cfo-ai-report.test.ts:56:24)

  ÔùÅ POST /api/cfo/ai-report ÔÇ║ 
executa AI report com provider 
gemini

    
expect(received).toBe(expected) 
// Object.is equality

    Expected: 200
    Received: 502

    [0m [90m 68 |[39m     
[36mawait[39m 
debugIfNotOk(res)[33m;[39m
     [90m 69 |[39m
    [31m[1m>[22m[39m[90m 70 
|[39m     expect(res[33m.[39mst
atus)[33m.[39mtoBe([35m200[39m
)[33m;[39m
     [90m    |[39m              
          [31m[1m^[22m[39m
     [90m 71 |[39m     expect(re
s[33m.[39mbody[33m.[39mreport)
[33m.[39mtoBe([32m"mock-report"
[39m)[33m;[39m
     [90m 72 |[39m     expect(mo
ckAdd)[33m.[39mtoHaveBeenCalled(
)[33m;[39m
     [90m 73 |[39m   
})[33m;[39m[0m

      at Object.<anonymous> (tests
/cfo-ai-report.test.ts:70:24)

PASS tests/billing-usage.test.ts

Test Suites: 3 failed, 7 passed, 
10 total
Tests:       2 failed, 10 passed, 
12 total
Snapshots:   0 total
Time:        10.178 s, estimated 
17 s
Ran all test suites.
