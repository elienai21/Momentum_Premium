
> momentum-platform@9.6.0 test:all
> npm --prefix functions run test -- --runInBand --detectOpenHandles


> momentum-functions@1.0.0 test
> jest --config ./jest.config.js --runInBand --detectOpenHandles

npm : 
ts-jest[ts-jest-transformer] 
(WARN) Define `ts-jest` 
config under `globals` is 
deprecated. Please do
No linha:1 caractere:1
+ npm run test:all > 
test_results_v5.txt 2>&1
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~
    + CategoryInfo           
   : NotSpecified: (ts-jest  
  [ts-jest...ated. Please    
 do:String) [], RemoteExc    
eption
    + FullyQualifiedErrorId  
   : NativeCommandError
 
transform: {
    <transform_regex>: 
['ts-jest', { /* ts-jest 
config goes here in Jest */ 
}],
},
See more at https://kulshekha
r.github.io/ts-jest/docs/gett
ing-started/presets#advanced
FAIL 
tests/public-signup.test.ts 
(13.292 s)
  ÔùÅ Console

    console.log
      {"level":"info","messag
e":"Public signup created 
new tenant","tenantId":"mock-
id-1","uid":"mock-user","emai
l":"","mode":"new"}

      at Object.info 
(src/utils/logger.ts:48:13)

  ÔùÅ Public signup ÔÇ║ cria 
tenant + member com status 
active e email

    
expect(received).toBeTruthy()

    Received: undefined

    [0m [90m 17 |[39m     
[36mconst[39m { db } 
[33m=[39m require([32m"src
/services/firebase"[39m) 
[36mas[39m any[33m;[39m
     [90m 18 |[39m     
[36mconst[39m tx 
[33m=[39m db[33m.[39m__la
stTransaction[33m;[39m
    
[31m[1m>[22m[39m[90m 19 
|[39m     expect(tx)[33m.[
39mtoBeTruthy()[33m;[39m
     [90m    |[39m         
       [31m[1m^[22m[39m
     [90m 20 |[39m     expe
ct(tx[33m.[39m[36mset[39m
)[33m.[39mtoHaveBeenCalled(
)[33m;[39m
     [90m 21 |[39m
     [90m 22 |[39m     
[36mconst[39m setCalls 
[33m=[39m 
(tx[33m.[39m[36mset[39m 
[36mas[39m jest[33m.[39m
[33mMock[39m)[33m.[39mmock
[33m.[39mcalls[33m;[39m[
0m

      at Object.<anonymous> (
tests/public-signup.test.ts:1
9:16)

FAIL 
tests/cfo-ai-report.test.ts
  ÔùÅ Test suite failed to 
run

    [96mtests/helpers/fireba
seMock.ts[0m:[93m1[0m:[93
m34[0m - 
[91merror[0m[90m TS2305: 
[0mModule 
'"../mocks/firebase"' has no 
exported member 'db'.

    [7m1[0m import { 
__resetMocks, __setDoc, db } 
from "../mocks/firebase";
    [7m [0m [91m          
                       ~~[0m

FAIL 
tests/billing-usage.test.ts
  ÔùÅ Test suite failed to 
run

    [96mtests/helpers/fireba
seMock.ts[0m:[93m1[0m:[93
m34[0m - 
[91merror[0m[90m TS2305: 
[0mModule 
'"../mocks/firebase"' has no 
exported member 'db'.

    [7m1[0m import { 
__resetMocks, __setDoc, db } 
from "../mocks/firebase";
    [7m [0m [91m          
                       ~~[0m

PASS tests/ai.test.ts
PASS tests/compliance.test.ts
  ÔùÅ Console

    console.log
      {"level":"info","messag
e":"Consent accepted by test-
uid","traceId":"453d1d82-7884
-4b58-989a-d1c64cb082f3"}

      at Object.info 
(src/utils/logger.ts:48:13)

FAIL tests/billing.test.ts
  ÔùÅ Billing ÔÇ║ reporta 
uso com sucesso

    TypeError: __setDoc is 
not a function

    [0m [90m 18 |[39m   
it([32m"reporta uso com 
sucesso"[39m[33m,[39m 
[36masync[39m () 
[33m=>[39m {
     [90m 19 |[39m     
[36mconst[39m { __setDoc } 
[33m=[39m require([32m"src
/services/firebase"[39m)[33
m;[39m
    
[31m[1m>[22m[39m[90m 20 
|[39m     __setDoc([32m"ten
ants/test-tenant"[39m[33m,
[39m { billing[33m:[39m { s
ubscriptionItemId[33m:[39m 
[32m"si_123"[39m } 
})[33m;[39m
     [90m    |[39m     
[31m[1m^[22m[39m
     [90m 21 |[39m
     [90m 22 |[39m     
[36mconst[39m app 
[33m=[39m 
makeTestApp()[33m;[39m
     [90m 23 |[39m     
[36mconst[39m res 
[33m=[39m [36mawait[39m 
request(app)[0m

      at Object.<anonymous> 
(tests/billing.test.ts:20:5)

PASS 
tests/cfo-summary.test.ts
PASS tests/withTenant-legacy-
status.test.ts
  ÔùÅ Console

    console.warn
      [TENANT_MEMBER_MISSING_
STATUS] { tenantId: 't1', 
uid: 'u1', traceId: null }

    [0m [90m 168 |[39m
     [90m 169 |[39m     
[36mif[39m 
([33m![39mmemberStatus) {
    
[31m[1m>[22m[39m[90m 
170 |[39m       console[33m
.[39mwarn([32m"[TENANT_MEMB
ER_MISSING_STATUS]"[39m[33m
,[39m {
     [90m     |[39m        
       [31m[1m^[22m[39m
     [90m 171 |[39m        
 tenantId[33m,[39m
     [90m 172 |[39m        
 uid[33m:[39m req[33m.[39
muser[33m?[39m[33m.[39mui
d [33m||[39m 
[36mnull[39m[33m,[39m
     [90m 173 |[39m        
 traceId[33m:[39m (req 
[36mas[39m 
any)[33m.[39mtraceId 
[33m||[39m 
[36mnull[39m[33m,[39m[0m

      at withTenant (src/midd
leware/withTenant.ts:170:15)

PASS tests/rateLimit.test.ts
  ÔùÅ Console

    console.error
      {"level":"error","type"
:"rate_limit_error","err":"Er
ror: Firestore unavailable"}

    [0m [90m 151 |[39m    
   [36mreturn[39m 
next()[33m;[39m
     [90m 152 |[39m     } 
[36mcatch[39m (e) {
    
[31m[1m>[22m[39m[90m 
153 |[39m       console[33m
.[39merror([33mJSON[39m[3
3m.[39mstringify({ 
level[33m:[39m 
[32m"error"[39m[33m,[39m 
type[33m:[39m [32m"rate_li
mit_error"[39m[33m,[39m 
err[33m:[39m 
[33mString[39m(e) 
}))[33m;[39m
     [90m     |[39m        
       [31m[1m^[22m[39m
     [90m 154 |[39m
     [90m 155 |[39m       
[90m// FALLBACK 
STRATEGY:[39m
     [90m 156 |[39m       
[90m// Check if this is a 
critical route that should 
fail-closed[39m[0m

      at rateLimit (src/middl
eware/rateLimit.ts:153:15)
      at Object.<anonymous> (
tests/rateLimit.test.ts:72:9)

    console.warn
      {"level":"warn","type":
"rate_limit_fail_closed","pat
h":"/api/billing/charge","rea
son":"Firestore unavailable 
for critical route"}

    [0m [90m 159 |[39m    
   [36mif[39m (isCritical) 
{
     [90m 160 |[39m        
 [90m// FAIL-CLOSED: Deny 
request on critical routes 
when Firestore fails[39m
    
[31m[1m>[22m[39m[90m 
161 |[39m         console[3
3m.[39mwarn([33mJSON[39m[
33m.[39mstringify({
     [90m     |[39m        
         [31m[1m^[22m[39m
     [90m 162 |[39m        
   level[33m:[39m 
[32m"warn"[39m[33m,[39m
     [90m 163 |[39m        
   type[33m:[39m [32m"rate
_limit_fail_closed"[39m[33m
,[39m
     [90m 164 |[39m        
   path[33m:[39m req[33m.
[39mpath[33m,[39m[0m

      at rateLimit (src/middl
eware/rateLimit.ts:161:17)
      at Object.<anonymous> (
tests/rateLimit.test.ts:72:9)

    console.error
      {"level":"error","type"
:"rate_limit_error","err":"Er
ror: Firestore unavailable"}

    [0m [90m 151 |[39m    
   [36mreturn[39m 
next()[33m;[39m
     [90m 152 |[39m     } 
[36mcatch[39m (e) {
    
[31m[1m>[22m[39m[90m 
153 |[39m       console[33m
.[39merror([33mJSON[39m[3
3m.[39mstringify({ 
level[33m:[39m 
[32m"error"[39m[33m,[39m 
type[33m:[39m [32m"rate_li
mit_error"[39m[33m,[39m 
err[33m:[39m 
[33mString[39m(e) 
}))[33m;[39m
     [90m     |[39m        
       [31m[1m^[22m[39m
     [90m 154 |[39m
     [90m 155 |[39m       
[90m// FALLBACK 
STRATEGY:[39m
     [90m 156 |[39m       
[90m// Check if this is a 
critical route that should 
fail-closed[39m[0m

      at rateLimit (src/middl
eware/rateLimit.ts:153:15)
      at Object.<anonymous> (
tests/rateLimit.test.ts:90:9)

    console.info
      {"level":"info","type":
"rate_limit_memory_fallback_o
k","path":"/api/public/status
"}

      at rateLimit (src/middl
eware/rateLimit.ts:198:17)

PASS tests/utils.test.ts

Test Suites: 4 failed, 6 
passed, 10 total
Tests:       2 failed, 7 
passed, 9 total
Snapshots:   0 total
Time:        17.088 s, 
estimated 21 s
Ran all test suites.
