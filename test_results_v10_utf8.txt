
> momentum-platform@9.6.0 test:all
> npm --prefix functions run test -- --runInBand --detectOpenHandles


> momentum-functions@1.0.0 test
> jest --config ./jest.config.js --runInBand --detectOpenHandles

npm : ts-jest[ts-jest-transformer] 
(WARN) Define `ts-jest` config 
under `globals` is deprecated. 
Please do
No linha:1 caractere:1
+ npm run test:all > 
test_results_v10.txt 2>&1
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~
    + CategoryInfo          : NotS 
   pecified: (ts-jest[ts-jest...a  
  ted. Please do:String) [], Rem   
 oteException
    + FullyQualifiedErrorId : Nati 
   veCommandError
 
transform: {
    <transform_regex>: ['ts-jest', 
{ /* ts-jest config goes here in 
Jest */ }],
},
See more at https://kulshekhar.gith
ub.io/ts-jest/docs/getting-started/
presets#advanced
FAIL tests/cfo-ai-report.test.ts 
(9.197 s)
  ÔùÅ Console

    console.log
      [TEST_DEBUG] status/body 502 
{
        error: "Cannot find module 
'../mocks/firebase' from 
'tests/cfo-ai-report.test.ts'",
        traceId: '8b23a993-23f5-431
5-bb51-e48542852fb8'
      }

      at debugIfNotOk 
(tests/helpers/testApp.ts:16:13)

    console.log
      [TEST_DEBUG] status/body 502 
{
        error: "Cannot find module 
'../mocks/firebase' from 
'tests/cfo-ai-report.test.ts'",
        traceId: '88bddcec-1095-4f4
3-9f61-f67faa01bce5'
      }

      at debugIfNotOk 
(tests/helpers/testApp.ts:16:13)

    console.log
      [TEST_DEBUG] status/body 403 
{
        ok: false,
        error: 'Feature not 
available in your plan.',
        feature: 'cfo_premium',
        plan: 'free',
        code: 'UPGRADE_REQUIRED'
      }

      at debugIfNotOk 
(tests/helpers/testApp.ts:16:13)

  ÔùÅ POST /api/cfo/ai-report ÔÇ║ 
executa AI report com provider 
openai

    
expect(received).toBe(expected) // 
Object.is equality

    Expected: 200
    Received: 502

    [0m [90m 58 |[39m     
[36mawait[39m 
debugIfNotOk(res)[33m;[39m
     [90m 59 |[39m
    [31m[1m>[22m[39m[90m 60 
|[39m     expect(res[33m.[39msta
tus)[33m.[39mtoBe([35m200[39m)
[33m;[39m
     [90m    |[39m               
         [31m[1m^[22m[39m
     [90m 61 |[39m     expect(res
[33m.[39mbody[33m.[39mreport)[
33m.[39mtoBe([32m"mock-report"[3
9m)[33m;[39m
     [90m 62 |[39m     
expect((generateCfoAiReport 
[36mas[39m any)[33m.[39mmock[3
3m.[39mcalls[33m.[39mlength)[33
m.[39mtoBeGreaterThan([35m0[39m)
[33m;[39m
     [90m 63 |[39m     expect(moc
kAdd)[33m.[39mtoHaveBeenCalled()
[33m;[39m [90m// usage 
log[39m[0m

      at Object.<anonymous> 
(tests/cfo-ai-report.test.ts:60:24)

  ÔùÅ POST /api/cfo/ai-report ÔÇ║ 
executa AI report com provider 
gemini

    
expect(received).toBe(expected) // 
Object.is equality

    Expected: 200
    Received: 502

    [0m [90m 73 |[39m     
[36mawait[39m 
debugIfNotOk(res)[33m;[39m
     [90m 74 |[39m
    [31m[1m>[22m[39m[90m 75 
|[39m     expect(res[33m.[39msta
tus)[33m.[39mtoBe([35m200[39m)
[33m;[39m
     [90m    |[39m               
         [31m[1m^[22m[39m
     [90m 76 |[39m     expect(res
[33m.[39mbody[33m.[39mreport)[
33m.[39mtoBe([32m"mock-report"[3
9m)[33m;[39m
     [90m 77 |[39m     expect(moc
kAdd)[33m.[39mtoHaveBeenCalled()
[33m;[39m
     [90m 78 |[39m   
})[33m;[39m[0m

      at Object.<anonymous> 
(tests/cfo-ai-report.test.ts:75:24)

FAIL tests/public-signup.test.ts
  ÔùÅ Console

    console.log
      
{"level":"info","message":"Public 
signup created new tenant","tenantI
d":"mock-id-1","uid":"mock-user","e
mail":"","mode":"new"}

      at Object.info 
(src/utils/logger.ts:48:13)

  ÔùÅ Public signup ÔÇ║ cria 
tenant + member com status active 
e email

    expect(received).toBeTruthy()

    Received: ""

    [0m [90m 34 |[39m     expect
(memberPayload[33m.[39mrole)[33m
.[39mtoBe([32m"admin"[39m)[33m;
[39m
     [90m 35 |[39m     expect(mem
berPayload[33m.[39mstatus)[33m.
[39mtoBe([32m"active"[39m)[33m;
[39m
    [31m[1m>[22m[39m[90m 36 
|[39m     expect(memberPayload[33
m.[39memail)[33m.[39mtoBeTruthy(
)[33m;[39m
     [90m    |[39m               
                  
[31m[1m^[22m[39m
     [90m 37 |[39m     expect(mem
berPayload[33m.[39mjoinedAt)[33m
.[39mtoBeTruthy()[33m;[39m
     [90m 38 |[39m   
})[33m;[39m
     [90m 39 |[39m 
})[33m;[39m[0m

      at Object.<anonymous> 
(tests/public-signup.test.ts:36:33)

PASS tests/billing-usage.test.ts
PASS tests/billing.test.ts
PASS tests/compliance.test.ts
  ÔùÅ Console

    console.log
      
{"level":"info","message":"Consent 
accepted by test-uid","traceId":"db
2dcc3e-e4e8-4349-b58e-0c53ef4bfb14"
}

      at Object.info 
(src/utils/logger.ts:48:13)

PASS tests/cfo-summary.test.ts
PASS tests/ai.test.ts
PASS tests/withTenant-legacy-status
.test.ts
  ÔùÅ Console

    console.warn
      
[TENANT_MEMBER_MISSING_STATUS] { 
tenantId: 't1', uid: 'u1', 
traceId: null }

    [0m [90m 168 |[39m
     [90m 169 |[39m     
[36mif[39m 
([33m![39mmemberStatus) {
    [31m[1m>[22m[39m[90m 170 
|[39m       console[33m.[39mwarn
([32m"[TENANT_MEMBER_MISSING_STATU
S]"[39m[33m,[39m {
     [90m     |[39m              
 [31m[1m^[22m[39m
     [90m 171 |[39m         
tenantId[33m,[39m
     [90m 172 |[39m         
uid[33m:[39m req[33m.[39muser[
33m?[39m[33m.[39muid 
[33m||[39m 
[36mnull[39m[33m,[39m
     [90m 173 |[39m         
traceId[33m:[39m (req 
[36mas[39m 
any)[33m.[39mtraceId 
[33m||[39m 
[36mnull[39m[33m,[39m[0m

      at withTenant (src/middleware
/withTenant.ts:170:15)

PASS tests/rateLimit.test.ts
  ÔùÅ Console

    console.error
      {"level":"error","type":"rate
_limit_error","err":"Error: 
Firestore unavailable"}

    [0m [90m 151 |[39m       
[36mreturn[39m next()[33m;[39m
     [90m 152 |[39m     } 
[36mcatch[39m (e) {
    [31m[1m>[22m[39m[90m 153 
|[39m       console[33m.[39merro
r([33mJSON[39m[33m.[39mstringif
y({ level[33m:[39m 
[32m"error"[39m[33m,[39m 
type[33m:[39m [32m"rate_limit_er
ror"[39m[33m,[39m 
err[33m:[39m [33mString[39m(e) 
}))[33m;[39m
     [90m     |[39m              
 [31m[1m^[22m[39m
     [90m 154 |[39m
     [90m 155 |[39m       
[90m// FALLBACK STRATEGY:[39m
     [90m 156 |[39m       
[90m// Check if this is a 
critical route that should 
fail-closed[39m[0m

      at rateLimit (src/middleware/
rateLimit.ts:153:15)
      at Object.<anonymous> 
(tests/rateLimit.test.ts:72:9)

    console.warn
      {"level":"warn","type":"rate_
limit_fail_closed","path":"/api/bil
ling/charge","reason":"Firestore 
unavailable for critical route"}

    [0m [90m 159 |[39m       
[36mif[39m (isCritical) {
     [90m 160 |[39m         
[90m// FAIL-CLOSED: Deny request 
on critical routes when Firestore 
fails[39m
    [31m[1m>[22m[39m[90m 161 
|[39m         console[33m.[39mwa
rn([33mJSON[39m[33m.[39mstringi
fy({
     [90m     |[39m              
   [31m[1m^[22m[39m
     [90m 162 |[39m           
level[33m:[39m 
[32m"warn"[39m[33m,[39m
     [90m 163 |[39m           
type[33m:[39m [32m"rate_limit_fa
il_closed"[39m[33m,[39m
     [90m 164 |[39m           
path[33m:[39m 
req[33m.[39mpath[33m,[39m[0m

      at rateLimit (src/middleware/
rateLimit.ts:161:17)
      at Object.<anonymous> 
(tests/rateLimit.test.ts:72:9)

    console.error
      {"level":"error","type":"rate
_limit_error","err":"Error: 
Firestore unavailable"}

    [0m [90m 151 |[39m       
[36mreturn[39m next()[33m;[39m
     [90m 152 |[39m     } 
[36mcatch[39m (e) {
    [31m[1m>[22m[39m[90m 153 
|[39m       console[33m.[39merro
r([33mJSON[39m[33m.[39mstringif
y({ level[33m:[39m 
[32m"error"[39m[33m,[39m 
type[33m:[39m [32m"rate_limit_er
ror"[39m[33m,[39m 
err[33m:[39m [33mString[39m(e) 
}))[33m;[39m
     [90m     |[39m              
 [31m[1m^[22m[39m
     [90m 154 |[39m
     [90m 155 |[39m       
[90m// FALLBACK STRATEGY:[39m
     [90m 156 |[39m       
[90m// Check if this is a 
critical route that should 
fail-closed[39m[0m

      at rateLimit (src/middleware/
rateLimit.ts:153:15)
      at Object.<anonymous> 
(tests/rateLimit.test.ts:90:9)

    console.info
      {"level":"info","type":"rate_
limit_memory_fallback_ok","path":"/
api/public/status"}

      at rateLimit (src/middleware/
rateLimit.ts:198:17)

PASS tests/utils.test.ts

Test Suites: 2 failed, 8 passed, 
10 total
Tests:       3 failed, 11 passed, 
14 total
Snapshots:   0 total
Time:        11.962 s, estimated 
12 s
Ran all test suites.
