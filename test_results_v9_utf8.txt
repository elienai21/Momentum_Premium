
> momentum-platform@9.6.0 test:all
> npm --prefix functions run test -- --runInBand --detectOpenHandles


> momentum-functions@1.0.0 test
> jest --config ./jest.config.js --runInBand --detectOpenHandles

npm : 
ts-jest[ts-jest-transformer] 
(WARN) Define `ts-jest` 
config under `globals` is 
deprecated. Please do
No linha:1 caractere:1
+ npm run test:all > 
test_results_v9.txt 2>&1
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~
    + CategoryInfo          : 
    NotSpecified: (ts-jest[t  
  s-jest...ated. Please do:   
 String) [], RemoteExcepti    
on
    + FullyQualifiedErrorId : 
    NativeCommandError
 
transform: {
    <transform_regex>: 
['ts-jest', { /* ts-jest 
config goes here in Jest */ 
}],
},
See more at https://kulshekhar
.github.io/ts-jest/docs/gettin
g-started/presets#advanced
FAIL 
tests/cfo-ai-report.test.ts 
(8.426 s)
  ÔùÅ Console

    console.log
      [TEST_DEBUG] 
status/body 502 {
        error: 'NO_CREDITS',
        traceId: 'c7001ffc-d32
1-455c-ba0f-8058bfc502ee'
      }

      at debugIfNotOk (tests/h
elpers/testApp.ts:16:13)

    console.log
      [TEST_DEBUG] 
status/body 502 {
        error: 'NO_CREDITS',
        traceId: '8c30445f-dec
b-46b2-ba3b-fe9897c0e183'
      }

      at debugIfNotOk (tests/h
elpers/testApp.ts:16:13)

    console.log
      [TEST_DEBUG] 
status/body 403 {
        ok: false,
        error: 'Feature not 
available in your plan.',
        feature: 
'cfo_premium',
        plan: 'free',
        code: 
'UPGRADE_REQUIRED'
      }

      at debugIfNotOk (tests/h
elpers/testApp.ts:16:13)

  ÔùÅ POST /api/cfo/ai-report 
ÔÇ║ executa AI report com 
provider openai

    expect(received).toBe(expe
cted) // Object.is equality

    Expected: 200
    Received: 502

    [0m [90m 68 |[39m     
[36mawait[39m 
debugIfNotOk(res)[33m;[39m
     [90m 69 |[39m
    [31m[1m>[22m[39m[90m 
70 |[39m     expect(res[33m.
[39mstatus)[33m.[39mtoBe([
35m200[39m)[33m;[39m
     [90m    |[39m          
              
[31m[1m^[22m[39m
     [90m 71 |[39m     expec
t(res[33m.[39mbody[33m.[39
mreport)[33m.[39mtoBe([32m"
mock-report"[39m)[33m;[39m
     [90m 72 |[39m     
expect((generateCfoAiReport 
[36mas[39m any)[33m.[39mmo
ck[33m.[39mcalls[33m.[39ml
ength)[33m.[39mtoBeGreaterTh
an([35m0[39m)[33m;[39m
     [90m 73 |[39m     expec
t(mockAdd)[33m.[39mtoHaveBee
nCalled()[33m;[39m [90m// 
usage log[39m[0m

      at Object.<anonymous> (t
ests/cfo-ai-report.test.ts:70:
24)

  ÔùÅ POST /api/cfo/ai-report 
ÔÇ║ executa AI report com 
provider gemini

    expect(received).toBe(expe
cted) // Object.is equality

    Expected: 200
    Received: 502

    [0m [90m 82 |[39m     
[36mawait[39m 
debugIfNotOk(res)[33m;[39m
     [90m 83 |[39m
    [31m[1m>[22m[39m[90m 
84 |[39m     expect(res[33m.
[39mstatus)[33m.[39mtoBe([
35m200[39m)[33m;[39m
     [90m    |[39m          
              
[31m[1m^[22m[39m
     [90m 85 |[39m     expec
t(res[33m.[39mbody[33m.[39
mreport)[33m.[39mtoBe([32m"
mock-report"[39m)[33m;[39m
     [90m 86 |[39m     expec
t(mockAdd)[33m.[39mtoHaveBee
nCalled()[33m;[39m
     [90m 87 |[39m   
})[33m;[39m[0m

      at Object.<anonymous> (t
ests/cfo-ai-report.test.ts:84:
24)

FAIL 
tests/public-signup.test.ts
  ÔùÅ Console

    console.log
      {"level":"info","message
":"Public signup created new t
enant","tenantId":"mock-id-1",
"uid":"mock-user","email":"","
mode":"new"}

      at Object.info 
(src/utils/logger.ts:48:13)

  ÔùÅ Public signup ÔÇ║ cria 
tenant + member com status 
active e email

    
expect(received).toBeTruthy()

    Received: undefined

    [0m [90m 25 |[39m      
 [33mString[39m(c[33m?[39m
[33m.[39m[[35m0[39m] 
[33m||[39m c[33m?[39m[33m
.[39m[[35m0[39m][33m?[39m
[33m.[39mpath [33m||[39m 
[32m""[39m)[33m.[39minclude
s([32m"/members/"[39m)
     [90m 26 |[39m     
)[33m;[39m
    [31m[1m>[22m[39m[90m 
27 |[39m     expect(memberSet
)[33m.[39mtoBeTruthy()[33m;
[39m
     [90m    |[39m          
             
[31m[1m^[22m[39m
     [90m 28 |[39m
     [90m 29 |[39m     
[36mif[39m 
([33m![39mmemberSet) 
[36mthrow[39m [36mnew[39m 
[33mError[39m([32m"memberSe
t not found"[39m)[33m;[39m
     [90m 30 |[39m     
[36mconst[39m memberPayload 
[33m=[39m 
memberSet[[35m1[39m] 
[36mas[39m 
any[33m;[39m[0m

      at Object.<anonymous> (t
ests/public-signup.test.ts:27:
23)

PASS tests/billing.test.ts
PASS tests/ai.test.ts
PASS 
tests/billing-usage.test.ts
PASS tests/compliance.test.ts
  ÔùÅ Console

    console.log
      {"level":"info","message
":"Consent accepted by test-ui
d","traceId":"3d809707-025a-48
3f-817e-a368fd67c9b7"}

      at Object.info 
(src/utils/logger.ts:48:13)

PASS tests/cfo-summary.test.ts
PASS tests/withTenant-legacy-s
tatus.test.ts
  ÔùÅ Console

    console.warn
      [TENANT_MEMBER_MISSING_S
TATUS] { tenantId: 't1', uid: 
'u1', traceId: null }

    [0m [90m 168 |[39m
     [90m 169 |[39m     
[36mif[39m 
([33m![39mmemberStatus) {
    [31m[1m>[22m[39m[90m 
170 |[39m       console[33m.
[39mwarn([32m"[TENANT_MEMBER
_MISSING_STATUS]"[39m[33m,[
39m {
     [90m     |[39m         
      [31m[1m^[22m[39m
     [90m 171 |[39m         
tenantId[33m,[39m
     [90m 172 |[39m         
uid[33m:[39m req[33m.[39mu
ser[33m?[39m[33m.[39muid 
[33m||[39m 
[36mnull[39m[33m,[39m
     [90m 173 |[39m         
traceId[33m:[39m (req 
[36mas[39m 
any)[33m.[39mtraceId 
[33m||[39m 
[36mnull[39m[33m,[39m[0m

      at withTenant (src/middl
eware/withTenant.ts:170:15)

PASS tests/rateLimit.test.ts
  ÔùÅ Console

    console.error
      {"level":"error","type":
"rate_limit_error","err":"Erro
r: Firestore unavailable"}

    [0m [90m 151 |[39m     
  [36mreturn[39m 
next()[33m;[39m
     [90m 152 |[39m     } 
[36mcatch[39m (e) {
    [31m[1m>[22m[39m[90m 
153 |[39m       console[33m.
[39merror([33mJSON[39m[33m
.[39mstringify({ 
level[33m:[39m 
[32m"error"[39m[33m,[39m 
type[33m:[39m [32m"rate_lim
it_error"[39m[33m,[39m 
err[33m:[39m 
[33mString[39m(e) 
}))[33m;[39m
     [90m     |[39m         
      [31m[1m^[22m[39m
     [90m 154 |[39m
     [90m 155 |[39m       
[90m// FALLBACK 
STRATEGY:[39m
     [90m 156 |[39m       
[90m// Check if this is a 
critical route that should 
fail-closed[39m[0m

      at rateLimit (src/middle
ware/rateLimit.ts:153:15)
      at Object.<anonymous> 
(tests/rateLimit.test.ts:72:9)

    console.warn
      {"level":"warn","type":"
rate_limit_fail_closed","path"
:"/api/billing/charge","reason
":"Firestore unavailable for 
critical route"}

    [0m [90m 159 |[39m     
  [36mif[39m (isCritical) {
     [90m 160 |[39m         
[90m// FAIL-CLOSED: Deny 
request on critical routes 
when Firestore fails[39m
    [31m[1m>[22m[39m[90m 
161 |[39m         console[33
m.[39mwarn([33mJSON[39m[33
m.[39mstringify({
     [90m     |[39m         
        [31m[1m^[22m[39m
     [90m 162 |[39m         
  level[33m:[39m 
[32m"warn"[39m[33m,[39m
     [90m 163 |[39m         
  type[33m:[39m [32m"rate_l
imit_fail_closed"[39m[33m,[
39m
     [90m 164 |[39m         
  path[33m:[39m req[33m.[3
9mpath[33m,[39m[0m

      at rateLimit (src/middle
ware/rateLimit.ts:161:17)
      at Object.<anonymous> 
(tests/rateLimit.test.ts:72:9)

    console.error
      {"level":"error","type":
"rate_limit_error","err":"Erro
r: Firestore unavailable"}

    [0m [90m 151 |[39m     
  [36mreturn[39m 
next()[33m;[39m
     [90m 152 |[39m     } 
[36mcatch[39m (e) {
    [31m[1m>[22m[39m[90m 
153 |[39m       console[33m.
[39merror([33mJSON[39m[33m
.[39mstringify({ 
level[33m:[39m 
[32m"error"[39m[33m,[39m 
type[33m:[39m [32m"rate_lim
it_error"[39m[33m,[39m 
err[33m:[39m 
[33mString[39m(e) 
}))[33m;[39m
     [90m     |[39m         
      [31m[1m^[22m[39m
     [90m 154 |[39m
     [90m 155 |[39m       
[90m// FALLBACK 
STRATEGY:[39m
     [90m 156 |[39m       
[90m// Check if this is a 
critical route that should 
fail-closed[39m[0m

      at rateLimit (src/middle
ware/rateLimit.ts:153:15)
      at Object.<anonymous> 
(tests/rateLimit.test.ts:90:9)

    console.info
      {"level":"info","type":"
rate_limit_memory_fallback_ok"
,"path":"/api/public/status"}

      at rateLimit (src/middle
ware/rateLimit.ts:198:17)

PASS tests/utils.test.ts

Test Suites: 2 failed, 8 
passed, 10 total
Tests:       3 failed, 11 
passed, 14 total
Snapshots:   0 total
Time:        11.429 s, 
estimated 15 s
Ran all test suites.

Jest has detected the 
following 1 open handle 
potentially keeping Jest from 
exiting:

  ÔùÅ  bound-anonymous-fn

    [0m [90m  6 |[39m   
it([32m"registra consentiment
o"[39m[33m,[39m 
[36masync[39m () 
[33m=>[39m {
     [90m  7 |[39m     
[36mconst[39m app 
[33m=[39m 
makeTestApp()[33m;[39m
    [31m[1m>[22m[39m[90m 
 8 |[39m     [36mconst[39m 
res [33m=[39m 
[36mawait[39m request(app)[
33m.[39mpost([32m"/api/compl
iance/consent"[39m)[33m.[39
msend({})[33m;[39m
     [90m    |[39m          
                          
[31m[1m^[22m[39m
     [90m  9 |[39m     
[36mawait[39m 
debugIfNotOk(res)[33m;[39m
     [90m 10 |[39m     expec
t(res[33m.[39mstatus)[33m.
[39mtoBe([35m200[39m)[33m;
[39m
     [90m 11 |[39m     expec
t(res[33m.[39mbody[33m.[39
mstatus)[33m.[39mtoBe([32m"
ok"[39m)[33m;[39m[0m

      at Test.serverAddress (n
ode_modules/supertest/lib/test
.js:63:35)
      at new Test (node_module
s/supertest/lib/test.js:49:14)
      at 
Object.obj.<computed> [as 
post] (node_modules/supertest/
index.js:39:18)
      at Object.<anonymous> (t
ests/compliance.test.ts:8:36)

