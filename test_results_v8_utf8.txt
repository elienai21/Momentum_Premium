
> momentum-platform@9.6.0 test:all
> npm --prefix functions run test -- --runInBand --detectOpenHandles


> momentum-functions@1.0.0 test
> jest --config ./jest.config.js --runInBand --detectOpenHandles

npm : ts-jest[ts-jest-transformer] 
(WARN) Define `ts-jest` config under 
`globals` is deprecated. Please do
No linha:1 caractere:1
+ npm run test:all > 
test_results_v8.txt 2>&1
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~
    + CategoryInfo          :     
NotSpecified: (ts-jest[t    
s-jest...ated. Please do:    String) 
[], RemoteExcepti    on
    + FullyQualifiedErrorId :     
NativeCommandError
 
transform: {
    <transform_regex>: ['ts-jest', { 
/* ts-jest config goes here in Jest 
*/ }],
},
See more at https://kulshekhar.github.
io/ts-jest/docs/getting-started/preset
s#advanced
FAIL tests/cfo-ai-report.test.ts 
(10.717 s)
  ÔùÅ Console

    console.log
      [TEST_DEBUG] status/body 502 {
        error: 'tenantRef.collection 
is not a function',
        traceId: 
'f0e4af83-8201-4306-919b-7237509d4694'
      }

      at debugIfNotOk 
(tests/helpers/testApp.ts:16:13)

    console.log
      [TEST_DEBUG] status/body 502 {
        error: 'tenantRef.collection 
is not a function',
        traceId: 
'b156b378-e6cf-41bd-8e0c-cff220015b80'
      }

      at debugIfNotOk 
(tests/helpers/testApp.ts:16:13)

    console.log
      [TEST_DEBUG] status/body 403 {
        ok: false,
        error: 'Feature not available 
in your plan.',
        feature: 'cfo_premium',
        plan: 'free',
        code: 'UPGRADE_REQUIRED'
      }

      at debugIfNotOk 
(tests/helpers/testApp.ts:16:13)

  ÔùÅ POST /api/cfo/ai-report ÔÇ║ 
executa AI report com provider openai

    expect(received).toBe(expected) 
// Object.is equality

    Expected: 200
    Received: 502

    [0m [90m 65 |[39m     
[36mawait[39m 
debugIfNotOk(res)[33m;[39m
     [90m 66 |[39m
    [31m[1m>[22m[39m[90m 67 
|[39m     expect(res[33m.[39mstatus
)[33m.[39mtoBe([35m200[39m)[33m;
[39m
     [90m    |[39m                  
      [31m[1m^[22m[39m
     [90m 68 |[39m     expect(res[3
3m.[39mbody[33m.[39mreport)[33m.[
39mtoBe([32m"mock-report"[39m)[33m;
[39m
     [90m 69 |[39m     
expect((generateCfoAiReport 
[36mas[39m any)[33m.[39mmock[33m.
[39mcalls[33m.[39mlength)[33m.[39
mtoBeGreaterThan([35m0[39m)[33m;[3
9m
     [90m 70 |[39m     expect(mockAd
d)[33m.[39mtoHaveBeenCalled()[33m;
[39m [90m// usage log[39m[0m

      at Object.<anonymous> 
(tests/cfo-ai-report.test.ts:67:24)

  ÔùÅ POST /api/cfo/ai-report ÔÇ║ 
executa AI report com provider gemini

    expect(received).toBe(expected) 
// Object.is equality

    Expected: 200
    Received: 502

    [0m [90m 79 |[39m     
[36mawait[39m 
debugIfNotOk(res)[33m;[39m
     [90m 80 |[39m
    [31m[1m>[22m[39m[90m 81 
|[39m     expect(res[33m.[39mstatus
)[33m.[39mtoBe([35m200[39m)[33m;
[39m
     [90m    |[39m                  
      [31m[1m^[22m[39m
     [90m 82 |[39m     expect(res[3
3m.[39mbody[33m.[39mreport)[33m.[
39mtoBe([32m"mock-report"[39m)[33m;
[39m
     [90m 83 |[39m     expect(mockAd
d)[33m.[39mtoHaveBeenCalled()[33m;
[39m
     [90m 84 |[39m   
})[33m;[39m[0m

      at Object.<anonymous> 
(tests/cfo-ai-report.test.ts:81:24)

PASS tests/billing-usage.test.ts
PASS tests/compliance.test.ts
  ÔùÅ Console

    console.log
      
{"level":"info","message":"Consent 
accepted by test-uid","traceId":"be120
5fc-3612-43f6-8084-238ef6ec5893"}

      at Object.info 
(src/utils/logger.ts:48:13)

PASS tests/ai.test.ts
PASS tests/cfo-summary.test.ts
PASS 
tests/withTenant-legacy-status.test.ts
  ÔùÅ Console

    console.warn
      [TENANT_MEMBER_MISSING_STATUS] 
{ tenantId: 't1', uid: 'u1', traceId: 
null }

    [0m [90m 168 |[39m
     [90m 169 |[39m     
[36mif[39m 
([33m![39mmemberStatus) {
    [31m[1m>[22m[39m[90m 170 
|[39m       console[33m.[39mwarn([
32m"[TENANT_MEMBER_MISSING_STATUS]"[3
9m[33m,[39m {
     [90m     |[39m               
[31m[1m^[22m[39m
     [90m 171 |[39m         
tenantId[33m,[39m
     [90m 172 |[39m         
uid[33m:[39m req[33m.[39muser[33m
?[39m[33m.[39muid [33m||[39m 
[36mnull[39m[33m,[39m
     [90m 173 |[39m         
traceId[33m:[39m (req [36mas[39m 
any)[33m.[39mtraceId [33m||[39m 
[36mnull[39m[33m,[39m[0m

      at withTenant 
(src/middleware/withTenant.ts:170:15)

PASS tests/rateLimit.test.ts
  ÔùÅ Console

    console.error
      {"level":"error","type":"rate_li
mit_error","err":"Error: Firestore 
unavailable"}

    [0m [90m 151 |[39m       
[36mreturn[39m next()[33m;[39m
     [90m 152 |[39m     } 
[36mcatch[39m (e) {
    [31m[1m>[22m[39m[90m 153 
|[39m       console[33m.[39merror(
[33mJSON[39m[33m.[39mstringify({ 
level[33m:[39m 
[32m"error"[39m[33m,[39m 
type[33m:[39m [32m"rate_limit_error
"[39m[33m,[39m err[33m:[39m 
[33mString[39m(e) }))[33m;[39m
     [90m     |[39m               
[31m[1m^[22m[39m
     [90m 154 |[39m
     [90m 155 |[39m       [90m// 
FALLBACK STRATEGY:[39m
     [90m 156 |[39m       [90m// 
Check if this is a critical route 
that should fail-closed[39m[0m

      at rateLimit 
(src/middleware/rateLimit.ts:153:15)
      at Object.<anonymous> 
(tests/rateLimit.test.ts:72:9)

    console.warn
      {"level":"warn","type":"rate_lim
it_fail_closed","path":"/api/billing/c
harge","reason":"Firestore 
unavailable for critical route"}

    [0m [90m 159 |[39m       
[36mif[39m (isCritical) {
     [90m 160 |[39m         [90m// 
FAIL-CLOSED: Deny request on critical 
routes when Firestore fails[39m
    [31m[1m>[22m[39m[90m 161 
|[39m         console[33m.[39mwarn(
[33mJSON[39m[33m.[39mstringify({
     [90m     |[39m                 
[31m[1m^[22m[39m
     [90m 162 |[39m           
level[33m:[39m 
[32m"warn"[39m[33m,[39m
     [90m 163 |[39m           
type[33m:[39m [32m"rate_limit_fail_
closed"[39m[33m,[39m
     [90m 164 |[39m           
path[33m:[39m 
req[33m.[39mpath[33m,[39m[0m

      at rateLimit 
(src/middleware/rateLimit.ts:161:17)
      at Object.<anonymous> 
(tests/rateLimit.test.ts:72:9)

    console.error
      {"level":"error","type":"rate_li
mit_error","err":"Error: Firestore 
unavailable"}

    [0m [90m 151 |[39m       
[36mreturn[39m next()[33m;[39m
     [90m 152 |[39m     } 
[36mcatch[39m (e) {
    [31m[1m>[22m[39m[90m 153 
|[39m       console[33m.[39merror(
[33mJSON[39m[33m.[39mstringify({ 
level[33m:[39m 
[32m"error"[39m[33m,[39m 
type[33m:[39m [32m"rate_limit_error
"[39m[33m,[39m err[33m:[39m 
[33mString[39m(e) }))[33m;[39m
     [90m     |[39m               
[31m[1m^[22m[39m
     [90m 154 |[39m
     [90m 155 |[39m       [90m// 
FALLBACK STRATEGY:[39m
     [90m 156 |[39m       [90m// 
Check if this is a critical route 
that should fail-closed[39m[0m

      at rateLimit 
(src/middleware/rateLimit.ts:153:15)
      at Object.<anonymous> 
(tests/rateLimit.test.ts:90:9)

    console.info
      {"level":"info","type":"rate_lim
it_memory_fallback_ok","path":"/api/pu
blic/status"}

      at rateLimit 
(src/middleware/rateLimit.ts:198:17)

PASS tests/utils.test.ts
FAIL tests/public-signup.test.ts
  ÔùÅ Console

    console.log
      
{"level":"info","message":"Public 
signup created new tenant","tenantId":
"mock-id-1","uid":"mock-user","email":
"","mode":"new"}

      at Object.info 
(src/utils/logger.ts:48:13)

  ÔùÅ Public signup ÔÇ║ cria tenant + 
member com status active e email

    
expect(received).toHaveBeenCalled()

    Matcher error: received value 
must be a mock or spy function

    Received has type:  function
    Received has value: [Function set]

    [0m [90m 19 |[39m     
[36mconst[39m tx [33m=[39m db[33m
.[39m__lastTransaction[33m;[39m
     [90m 20 |[39m     expect(tx)[3
3m.[39mtoBeTruthy()[33m;[39m
    [31m[1m>[22m[39m[90m 21 
|[39m     expect(tx[33m.[39m[36mse
t[39m)[33m.[39mtoHaveBeenCalled()[
33m;[39m
     [90m    |[39m                  
  [31m[1m^[22m[39m
     [90m 22 |[39m
     [90m 23 |[39m     
[36mconst[39m setCalls [33m=[39m 
(tx[33m.[39m[36mset[39m 
[36mas[39m jest[33m.[39m[33mMock
[39m)[33m.[39mmock[33m.[39mcalls[
33m;[39m
     [90m 24 |[39m     
[36mconst[39m memberSet [33m=[39m 
setCalls[33m.[39mfind((c[33m:[39m 
any[]) [33m=>[39m[0m

      at Object.<anonymous> 
(tests/public-signup.test.ts:21:20)

FAIL tests/billing.test.ts
  ÔùÅ Billing ÔÇ║ reporta uso com 
sucesso

    expect(received).toBeTruthy()

    Received: undefined

    [0m [90m 20 |[39m     
[36mconst[39m { db } [33m=[39m 
require([32m"firebase-admin"[39m) 
[36mas[39m any[33m;[39m
     [90m 21 |[39m     
[36mconst[39m tx [33m=[39m db[33m
.[39m__lastTransaction[33m;[39m
    [31m[1m>[22m[39m[90m 22 
|[39m     expect(tx)[33m.[39mtoBeTr
uthy()[33m;[39m
     [90m    |[39m                
[31m[1m^[22m[39m
     [90m 23 |[39m     tx[33m.[39m
[36mset[39m([32m"tenants/test-tenan
t"[39m[33m,[39m { 
billing[33m:[39m { 
subscriptionItemId[33m:[39m 
[32m"si_123"[39m } })[33m;[39m
     [90m 24 |[39m
     [90m 25 |[39m     
[36mconst[39m app [33m=[39m 
makeTestApp()[33m;[39m[0m

      at Object.<anonymous> 
(tests/billing.test.ts:22:16)

Test Suites: 3 failed, 7 passed, 10 
total
Tests:       4 failed, 10 passed, 14 
total
Snapshots:   0 total
Time:        14.902 s
Ran all test suites.
