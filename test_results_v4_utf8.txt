
> momentum-platform@9.6.0 test:all
> npm --prefix functions run test -- --runInBand --detectOpenHandles


> momentum-functions@1.0.0 test
> jest --config ./jest.config.js --runInBand --detectOpenHandles

npm : 
ts-jest[ts-jest-transformer] 
(WARN) Define `ts-jest` 
config under `globals` is 
deprecated. Please do
No linha:1 caractere:1
+ npm run test:all > 
test_results_v4.txt 2>&1
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~
    + CategoryInfo           
   : NotSpecified: (ts-jest  
  [ts-jest...ated. Please    
 do:String) [], RemoteExc    
eption
    + FullyQualifiedErrorId  
   : NativeCommandError
 
transform: {
    <transform_regex>: 
['ts-jest', { /* ts-jest 
config goes here in Jest */ 
}],
},
See more at https://kulshekha
r.github.io/ts-jest/docs/gett
ing-started/presets#advanced
FAIL 
tests/public-signup.test.ts 
(11.828 s)
  ÔùÅ Console

    console.log
      [TEST_DEBUG] 
status/body 500 {
        error: '(0 , 
firebase_admin_1.auth) is 
not a function',
        traceId: '950dc7bc-55
22-45f2-8ff3-9050af5d8647'
      }

      at debugIfNotOk (tests/
helpers/testApp.ts:16:13)

  ÔùÅ Public signup ÔÇ║ cria 
tenant + member com status 
active e email

    expect(received).toBe(exp
ected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 12 |[39m
     [90m 13 |[39m     
[36mawait[39m 
debugIfNotOk(res)[33m;[39m
    
[31m[1m>[22m[39m[90m 14 
|[39m     expect(res[33m.[
39mstatus)[33m.[39mtoBe([3
5m201[39m)[33m;[39m
     [90m    |[39m         
               
[31m[1m^[22m[39m
     [90m 15 |[39m     expe
ct(res[33m.[39mbody[33m?[
39m[33m.[39mdata[33m?[39m
[33m.[39mtenantId)[33m.[3
9mtoBeTruthy()[33m;[39m
     [90m 16 |[39m
     [90m 17 |[39m     
[36mconst[39m { db } 
[33m=[39m require([32m"src
/services/firebase"[39m) 
[36mas[39m 
any[33m;[39m[0m

      at Object.<anonymous> (
tests/public-signup.test.ts:1
4:24)

FAIL 
tests/cfo-ai-report.test.ts
  ÔùÅ Console

    console.log
      [TEST_DEBUG] 
status/body 502 {
        error: 'firebase_1.db
.runTransaction is not a 
function',
        traceId: 'b3805430-10
92-4170-bb3b-f3b60ca94b3f'
      }

      at debugIfNotOk (tests/
helpers/testApp.ts:16:13)

    console.log
      [TEST_DEBUG] 
status/body 502 {
        error: 'firebase_1.db
.runTransaction is not a 
function',
        traceId: '68e4632a-42
6e-4958-aa9c-19d917506422'
      }

      at debugIfNotOk (tests/
helpers/testApp.ts:16:13)

    console.log
      [TEST_DEBUG] 
status/body 403 {
        ok: false,
        error: 'Feature not 
available in your plan.',
        feature: 
'cfo_premium',
        plan: 'free',
        code: 
'UPGRADE_REQUIRED'
      }

      at debugIfNotOk (tests/
helpers/testApp.ts:16:13)

  ÔùÅ POST 
/api/cfo/ai-report ÔÇ║ 
executa AI report com 
provider openai

    expect(received).toBe(exp
ected) // Object.is equality

    Expected: 200
    Received: 502

    [0m [90m 47 |[39m     
[36mawait[39m 
debugIfNotOk(res)[33m;[39m
     [90m 48 |[39m
    
[31m[1m>[22m[39m[90m 49 
|[39m     expect(res[33m.[
39mstatus)[33m.[39mtoBe([3
5m200[39m)[33m;[39m
     [90m    |[39m         
               
[31m[1m^[22m[39m
     [90m 50 |[39m     expe
ct(res[33m.[39mbody[33m.[
39mreport)[33m.[39mtoBe([3
2m"mock-report"[39m)[33m;[
39m
     [90m 51 |[39m     
expect((generateCfoAiReport 
[36mas[39m jest[33m.[39m
[33mMock[39m)[33m.[39mmock
[33m.[39mcalls[33m.[39mle
ngth)[33m.[39mtoBeGreaterTh
an([35m0[39m)[33m;[39m
     [90m 52 |[39m     expe
ct(mockAdd)[33m.[39mtoHaveB
eenCalled()[33m;[39m 
[90m// usage log[39m[0m

      at Object.<anonymous> (
tests/cfo-ai-report.test.ts:4
9:24)

  ÔùÅ POST 
/api/cfo/ai-report ÔÇ║ 
executa AI report com 
provider gemini

    expect(received).toBe(exp
ected) // Object.is equality

    Expected: 200
    Received: 502

    [0m [90m 61 |[39m     
[36mawait[39m 
debugIfNotOk(res)[33m;[39m
     [90m 62 |[39m
    
[31m[1m>[22m[39m[90m 63 
|[39m     expect(res[33m.[
39mstatus)[33m.[39mtoBe([3
5m200[39m)[33m;[39m
     [90m    |[39m         
               
[31m[1m^[22m[39m
     [90m 64 |[39m     expe
ct(res[33m.[39mbody[33m.[
39mreport)[33m.[39mtoBe([3
2m"mock-report"[39m)[33m;[
39m
     [90m 65 |[39m     expe
ct(mockAdd)[33m.[39mtoHaveB
eenCalled()[33m;[39m
     [90m 66 |[39m   
})[33m;[39m[0m

      at Object.<anonymous> (
tests/cfo-ai-report.test.ts:6
3:24)

PASS tests/compliance.test.ts
  ÔùÅ Console

    console.log
      {"level":"info","messag
e":"Consent accepted by test-
uid","traceId":"661a2a00-658a
-4b38-86c5-6c9c6a8fab3e"}

      at Object.info 
(src/utils/logger.ts:48:13)

PASS tests/billing.test.ts
PASS 
tests/billing-usage.test.ts
PASS tests/ai.test.ts
PASS tests/withTenant-legacy-
status.test.ts
  ÔùÅ Console

    console.warn
      [TENANT_MEMBER_MISSING_
STATUS] { tenantId: 't1', 
uid: 'u1', traceId: null }

    [0m [90m 168 |[39m
     [90m 169 |[39m     
[36mif[39m 
([33m![39mmemberStatus) {
    
[31m[1m>[22m[39m[90m 
170 |[39m       console[33m
.[39mwarn([32m"[TENANT_MEMB
ER_MISSING_STATUS]"[39m[33m
,[39m {
     [90m     |[39m        
       [31m[1m^[22m[39m
     [90m 171 |[39m        
 tenantId[33m,[39m
     [90m 172 |[39m        
 uid[33m:[39m req[33m.[39
muser[33m?[39m[33m.[39mui
d [33m||[39m 
[36mnull[39m[33m,[39m
     [90m 173 |[39m        
 traceId[33m:[39m (req 
[36mas[39m 
any)[33m.[39mtraceId 
[33m||[39m 
[36mnull[39m[33m,[39m[0m

      at withTenant (src/midd
leware/withTenant.ts:170:15)

PASS 
tests/cfo-summary.test.ts
PASS tests/rateLimit.test.ts
  ÔùÅ Console

    console.error
      {"level":"error","type"
:"rate_limit_error","err":"Er
ror: Firestore unavailable"}

    [0m [90m 151 |[39m    
   [36mreturn[39m 
next()[33m;[39m
     [90m 152 |[39m     } 
[36mcatch[39m (e) {
    
[31m[1m>[22m[39m[90m 
153 |[39m       console[33m
.[39merror([33mJSON[39m[3
3m.[39mstringify({ 
level[33m:[39m 
[32m"error"[39m[33m,[39m 
type[33m:[39m [32m"rate_li
mit_error"[39m[33m,[39m 
err[33m:[39m 
[33mString[39m(e) 
}))[33m;[39m
     [90m     |[39m        
       [31m[1m^[22m[39m
     [90m 154 |[39m
     [90m 155 |[39m       
[90m// FALLBACK 
STRATEGY:[39m
     [90m 156 |[39m       
[90m// Check if this is a 
critical route that should 
fail-closed[39m[0m

      at rateLimit (src/middl
eware/rateLimit.ts:153:15)
      at Object.<anonymous> (
tests/rateLimit.test.ts:72:9)

    console.warn
      {"level":"warn","type":
"rate_limit_fail_closed","pat
h":"/api/billing/charge","rea
son":"Firestore unavailable 
for critical route"}

    [0m [90m 159 |[39m    
   [36mif[39m (isCritical) 
{
     [90m 160 |[39m        
 [90m// FAIL-CLOSED: Deny 
request on critical routes 
when Firestore fails[39m
    
[31m[1m>[22m[39m[90m 
161 |[39m         console[3
3m.[39mwarn([33mJSON[39m[
33m.[39mstringify({
     [90m     |[39m        
         [31m[1m^[22m[39m
     [90m 162 |[39m        
   level[33m:[39m 
[32m"warn"[39m[33m,[39m
     [90m 163 |[39m        
   type[33m:[39m [32m"rate
_limit_fail_closed"[39m[33m
,[39m
     [90m 164 |[39m        
   path[33m:[39m req[33m.
[39mpath[33m,[39m[0m

      at rateLimit (src/middl
eware/rateLimit.ts:161:17)
      at Object.<anonymous> (
tests/rateLimit.test.ts:72:9)

    console.error
      {"level":"error","type"
:"rate_limit_error","err":"Er
ror: Firestore unavailable"}

    [0m [90m 151 |[39m    
   [36mreturn[39m 
next()[33m;[39m
     [90m 152 |[39m     } 
[36mcatch[39m (e) {
    
[31m[1m>[22m[39m[90m 
153 |[39m       console[33m
.[39merror([33mJSON[39m[3
3m.[39mstringify({ 
level[33m:[39m 
[32m"error"[39m[33m,[39m 
type[33m:[39m [32m"rate_li
mit_error"[39m[33m,[39m 
err[33m:[39m 
[33mString[39m(e) 
}))[33m;[39m
     [90m     |[39m        
       [31m[1m^[22m[39m
     [90m 154 |[39m
     [90m 155 |[39m       
[90m// FALLBACK 
STRATEGY:[39m
     [90m 156 |[39m       
[90m// Check if this is a 
critical route that should 
fail-closed[39m[0m

      at rateLimit (src/middl
eware/rateLimit.ts:153:15)
      at Object.<anonymous> (
tests/rateLimit.test.ts:90:9)

    console.info
      {"level":"info","type":
"rate_limit_memory_fallback_o
k","path":"/api/public/status
"}

      at rateLimit (src/middl
eware/rateLimit.ts:198:17)

PASS tests/utils.test.ts

Test Suites: 2 failed, 8 
passed, 10 total
Tests:       3 failed, 11 
passed, 14 total
Snapshots:   0 total
Time:        20.852 s
Ran all test suites.
