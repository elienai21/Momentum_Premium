
> momentum-platform@9.6.0 test:all
> npm --prefix functions run test -- --runInBand --detectOpenHandles


> momentum-functions@1.0.0 test
> jest --config ./jest.config.js --runInBand --detectOpenHandles

npm : 
ts-jest[ts-jest-transformer] 
(WARN) Define `ts-jest` 
config under `globals` is 
deprecated. Please do
No linha:1 caractere:1
+ npm run test:all > 
test_results_v3.txt 2>&1
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~
~~~~~~~~~~~~~~~~
    + CategoryInfo           
   : NotSpecified: (ts-jest  
  [ts-jest...ated. Please    
 do:String) [], RemoteExc    
eption
    + FullyQualifiedErrorId  
   : NativeCommandError
 
transform: {
    <transform_regex>: 
['ts-jest', { /* ts-jest 
config goes here in Jest */ 
}],
},
See more at https://kulshekha
r.github.io/ts-jest/docs/gett
ing-started/presets#advanced
PASS tests/withTenant-legacy-
status.test.ts (8.036 s)
  ÔùÅ Console

    console.warn
      [TENANT_MEMBER_MISSING_
STATUS] { tenantId: 't1', 
uid: 'u1', traceId: null }

    [0m [90m 168 |[39m
     [90m 169 |[39m     
[36mif[39m 
([33m![39mmemberStatus) {
    
[31m[1m>[22m[39m[90m 
170 |[39m       console[33m
.[39mwarn([32m"[TENANT_MEMB
ER_MISSING_STATUS]"[39m[33m
,[39m {
     [90m     |[39m        
       [31m[1m^[22m[39m
     [90m 171 |[39m        
 tenantId[33m,[39m
     [90m 172 |[39m        
 uid[33m:[39m req[33m.[39
muser[33m?[39m[33m.[39mui
d [33m||[39m 
[36mnull[39m[33m,[39m
     [90m 173 |[39m        
 traceId[33m:[39m (req 
[36mas[39m 
any)[33m.[39mtraceId 
[33m||[39m 
[36mnull[39m[33m,[39m[0m

      at withTenant (src/midd
leware/withTenant.ts:170:15)

PASS tests/utils.test.ts
PASS tests/rateLimit.test.ts
  ÔùÅ Console

    console.error
      {"level":"error","type"
:"rate_limit_error","err":"Er
ror: Firestore unavailable"}

    [0m [90m 151 |[39m    
   [36mreturn[39m 
next()[33m;[39m
     [90m 152 |[39m     } 
[36mcatch[39m (e) {
    
[31m[1m>[22m[39m[90m 
153 |[39m       console[33m
.[39merror([33mJSON[39m[3
3m.[39mstringify({ 
level[33m:[39m 
[32m"error"[39m[33m,[39m 
type[33m:[39m [32m"rate_li
mit_error"[39m[33m,[39m 
err[33m:[39m 
[33mString[39m(e) 
}))[33m;[39m
     [90m     |[39m        
       [31m[1m^[22m[39m
     [90m 154 |[39m
     [90m 155 |[39m       
[90m// FALLBACK 
STRATEGY:[39m
     [90m 156 |[39m       
[90m// Check if this is a 
critical route that should 
fail-closed[39m[0m

      at rateLimit (src/middl
eware/rateLimit.ts:153:15)
      at Object.<anonymous> (
tests/rateLimit.test.ts:72:9)

    console.warn
      {"level":"warn","type":
"rate_limit_fail_closed","pat
h":"/api/billing/charge","rea
son":"Firestore unavailable 
for critical route"}

    [0m [90m 159 |[39m    
   [36mif[39m (isCritical) 
{
     [90m 160 |[39m        
 [90m// FAIL-CLOSED: Deny 
request on critical routes 
when Firestore fails[39m
    
[31m[1m>[22m[39m[90m 
161 |[39m         console[3
3m.[39mwarn([33mJSON[39m[
33m.[39mstringify({
     [90m     |[39m        
         [31m[1m^[22m[39m
     [90m 162 |[39m        
   level[33m:[39m 
[32m"warn"[39m[33m,[39m
     [90m 163 |[39m        
   type[33m:[39m [32m"rate
_limit_fail_closed"[39m[33m
,[39m
     [90m 164 |[39m        
   path[33m:[39m req[33m.
[39mpath[33m,[39m[0m

      at rateLimit (src/middl
eware/rateLimit.ts:161:17)
      at Object.<anonymous> (
tests/rateLimit.test.ts:72:9)

    console.error
      {"level":"error","type"
:"rate_limit_error","err":"Er
ror: Firestore unavailable"}

    [0m [90m 151 |[39m    
   [36mreturn[39m 
next()[33m;[39m
     [90m 152 |[39m     } 
[36mcatch[39m (e) {
    
[31m[1m>[22m[39m[90m 
153 |[39m       console[33m
.[39merror([33mJSON[39m[3
3m.[39mstringify({ 
level[33m:[39m 
[32m"error"[39m[33m,[39m 
type[33m:[39m [32m"rate_li
mit_error"[39m[33m,[39m 
err[33m:[39m 
[33mString[39m(e) 
}))[33m;[39m
     [90m     |[39m        
       [31m[1m^[22m[39m
     [90m 154 |[39m
     [90m 155 |[39m       
[90m// FALLBACK 
STRATEGY:[39m
     [90m 156 |[39m       
[90m// Check if this is a 
critical route that should 
fail-closed[39m[0m

      at rateLimit (src/middl
eware/rateLimit.ts:153:15)
      at Object.<anonymous> (
tests/rateLimit.test.ts:90:9)

    console.info
      {"level":"info","type":
"rate_limit_memory_fallback_o
k","path":"/api/public/status
"}

      at rateLimit (src/middl
eware/rateLimit.ts:198:17)

FAIL 
tests/public-signup.test.ts
  ÔùÅ Public signup ÔÇ║ cria 
tenant + member com status 
active e email

    TypeError: Cannot read 
properties of undefined 
(reading 'length')

    [0m [90m 2 |[39m 
[36mimport[39m [33m*[39m 
[36mas[39m admin 
[36mfrom[39m [32m"firebase
-admin"[39m[33m;[39m
     [90m 3 |[39m
    
[31m[1m>[22m[39m[90m 4 
|[39m [36mif[39m ([33m![
39madmin[33m.[39mapps[33m.
[39mlength) {
     [90m   |[39m          
       [31m[1m^[22m[39m
     [90m 5 |[39m   admin[
33m.[39minitializeApp()[33m
;[39m
     [90m 6 |[39m }
     [90m 7 |[39m 
[36mconst[39m db 
[33m=[39m admin[33m.[39mf
irestore()[33m;[39m[0m

      at Object.<anonymous> (
src/services/marketConfigServ
ice.ts:4:17)
      at Object.<anonymous> 
(src/routes/market.ts:7:1)
      at createExpressApp (sr
c/app/createExpressApp.ts:131
:24)
      at makeTestApp (tests/h
elpers/testApp.ts:10:26)
      at Object.<anonymous> (
tests/public-signup.test.ts:7
:28)

FAIL tests/compliance.test.ts
  ÔùÅ Compliance ÔÇ║ 
registra consentimento

    TypeError: Cannot read 
properties of undefined 
(reading 'length')

    [0m [90m 2 |[39m 
[36mimport[39m [33m*[39m 
[36mas[39m admin 
[36mfrom[39m [32m"firebase
-admin"[39m[33m;[39m
     [90m 3 |[39m
    
[31m[1m>[22m[39m[90m 4 
|[39m [36mif[39m ([33m![
39madmin[33m.[39mapps[33m.
[39mlength) {
     [90m   |[39m          
       [31m[1m^[22m[39m
     [90m 5 |[39m   admin[
33m.[39minitializeApp()[33m
;[39m
     [90m 6 |[39m }
     [90m 7 |[39m 
[36mconst[39m db 
[33m=[39m admin[33m.[39mf
irestore()[33m;[39m[0m

      at Object.<anonymous> (
src/services/marketConfigServ
ice.ts:4:17)
      at Object.<anonymous> 
(src/routes/market.ts:7:1)
      at createExpressApp (sr
c/app/createExpressApp.ts:131
:24)
      at makeTestApp (tests/h
elpers/testApp.ts:10:26)
      at Object.<anonymous> (
tests/compliance.test.ts:7:28
)

FAIL 
tests/billing-usage.test.ts
  ÔùÅ Billing usage 
endpoints ÔÇ║ GET 
/api/billing/usage retorna 
├║ltimos logs

    TypeError: Cannot read 
properties of undefined 
(reading 'length')

    [0m [90m 2 |[39m 
[36mimport[39m [33m*[39m 
[36mas[39m admin 
[36mfrom[39m [32m"firebase
-admin"[39m[33m;[39m
     [90m 3 |[39m
    
[31m[1m>[22m[39m[90m 4 
|[39m [36mif[39m ([33m![
39madmin[33m.[39mapps[33m.
[39mlength) {
     [90m   |[39m          
       [31m[1m^[22m[39m
     [90m 5 |[39m   admin[
33m.[39minitializeApp()[33m
;[39m
     [90m 6 |[39m }
     [90m 7 |[39m 
[36mconst[39m db 
[33m=[39m admin[33m.[39mf
irestore()[33m;[39m[0m

      at Object.<anonymous> (
src/services/marketConfigServ
ice.ts:4:17)
      at Object.<anonymous> 
(src/routes/market.ts:7:1)
      at createExpressApp (sr
c/app/createExpressApp.ts:131
:24)
      at makeTestApp (tests/h
elpers/testApp.ts:10:26)
      at Object.<anonymous> (
tests/billing-usage.test.ts:1
5:28)

  ÔùÅ Billing usage 
endpoints ÔÇ║ POST 
/api/billing/report 
incrementa uso no Stripe

    TypeError: Cannot read 
properties of undefined 
(reading 'length')

    [0m [90m 2 |[39m 
[36mimport[39m [33m*[39m 
[36mas[39m admin 
[36mfrom[39m [32m"firebase
-admin"[39m[33m;[39m
     [90m 3 |[39m
    
[31m[1m>[22m[39m[90m 4 
|[39m [36mif[39m ([33m![
39madmin[33m.[39mapps[33m.
[39mlength) {
     [90m   |[39m          
       [31m[1m^[22m[39m
     [90m 5 |[39m   admin[
33m.[39minitializeApp()[33m
;[39m
     [90m 6 |[39m }
     [90m 7 |[39m 
[36mconst[39m db 
[33m=[39m admin[33m.[39mf
irestore()[33m;[39m[0m

      at Object.<anonymous> (
src/services/marketConfigServ
ice.ts:4:17)
      at Object.<anonymous> 
(src/routes/market.ts:7:1)
      at createExpressApp (sr
c/app/createExpressApp.ts:131
:24)
      at makeTestApp (tests/h
elpers/testApp.ts:10:26)
      at Object.<anonymous> (
tests/billing-usage.test.ts:2
4:28)

PASS 
tests/cfo-summary.test.ts
FAIL tests/ai.test.ts
  ÔùÅ AI Insights ÔÇ║ gera 
insights v├ílidos

    TypeError: Cannot read 
properties of undefined 
(reading 'length')

    [0m [90m 2 |[39m 
[36mimport[39m [33m*[39m 
[36mas[39m admin 
[36mfrom[39m [32m"firebase
-admin"[39m[33m;[39m
     [90m 3 |[39m
    
[31m[1m>[22m[39m[90m 4 
|[39m [36mif[39m ([33m![
39madmin[33m.[39mapps[33m.
[39mlength) {
     [90m   |[39m          
       [31m[1m^[22m[39m
     [90m 5 |[39m   admin[
33m.[39minitializeApp()[33m
;[39m
     [90m 6 |[39m }
     [90m 7 |[39m 
[36mconst[39m db 
[33m=[39m admin[33m.[39mf
irestore()[33m;[39m[0m

      at Object.<anonymous> (
src/services/marketConfigServ
ice.ts:4:17)
      at Object.<anonymous> 
(src/routes/market.ts:7:1)
      at createExpressApp (sr
c/app/createExpressApp.ts:131
:24)
      at makeTestApp (tests/h
elpers/testApp.ts:10:26)
      at Object.<anonymous> 
(tests/ai.test.ts:7:28)

FAIL 
tests/cfo-ai-report.test.ts
  ÔùÅ POST 
/api/cfo/ai-report ÔÇ║ 
executa AI report com 
provider openai

    TypeError: Cannot read 
properties of undefined 
(reading 'length')

    [0m [90m 2 |[39m 
[36mimport[39m [33m*[39m 
[36mas[39m admin 
[36mfrom[39m [32m"firebase
-admin"[39m[33m;[39m
     [90m 3 |[39m
    
[31m[1m>[22m[39m[90m 4 
|[39m [36mif[39m ([33m![
39madmin[33m.[39mapps[33m.
[39mlength) {
     [90m   |[39m          
       [31m[1m^[22m[39m
     [90m 5 |[39m   admin[
33m.[39minitializeApp()[33m
;[39m
     [90m 6 |[39m }
     [90m 7 |[39m 
[36mconst[39m db 
[33m=[39m admin[33m.[39mf
irestore()[33m;[39m[0m

      at Object.<anonymous> (
src/services/marketConfigServ
ice.ts:4:17)
      at Object.<anonymous> 
(src/routes/market.ts:7:1)
      at createExpressApp (sr
c/app/createExpressApp.ts:131
:24)
      at makeTestApp (tests/h
elpers/testApp.ts:10:26)
      at Object.<anonymous> (
tests/cfo-ai-report.test.ts:4
2:28)

  ÔùÅ POST 
/api/cfo/ai-report ÔÇ║ 
executa AI report com 
provider gemini

    TypeError: Cannot read 
properties of undefined 
(reading 'length')

    [0m [90m 2 |[39m 
[36mimport[39m [33m*[39m 
[36mas[39m admin 
[36mfrom[39m [32m"firebase
-admin"[39m[33m;[39m
     [90m 3 |[39m
    
[31m[1m>[22m[39m[90m 4 
|[39m [36mif[39m ([33m![
39madmin[33m.[39mapps[33m.
[39mlength) {
     [90m   |[39m          
       [31m[1m^[22m[39m
     [90m 5 |[39m   admin[
33m.[39minitializeApp()[33m
;[39m
     [90m 6 |[39m }
     [90m 7 |[39m 
[36mconst[39m db 
[33m=[39m admin[33m.[39mf
irestore()[33m;[39m[0m

      at Object.<anonymous> (
src/services/marketConfigServ
ice.ts:4:17)
      at Object.<anonymous> 
(src/routes/market.ts:7:1)
      at createExpressApp (sr
c/app/createExpressApp.ts:131
:24)
      at makeTestApp (tests/h
elpers/testApp.ts:10:26)
      at Object.<anonymous> (
tests/cfo-ai-report.test.ts:5
6:28)

  ÔùÅ POST 
/api/cfo/ai-report ÔÇ║ nega 
acesso quando plano ├® free 
(gating)

    TypeError: Cannot read 
properties of undefined 
(reading 'length')

    [0m [90m 2 |[39m 
[36mimport[39m [33m*[39m 
[36mas[39m admin 
[36mfrom[39m [32m"firebase
-admin"[39m[33m;[39m
     [90m 3 |[39m
    
[31m[1m>[22m[39m[90m 4 
|[39m [36mif[39m ([33m![
39madmin[33m.[39mapps[33m.
[39mlength) {
     [90m   |[39m          
       [31m[1m^[22m[39m
     [90m 5 |[39m   admin[
33m.[39minitializeApp()[33m
;[39m
     [90m 6 |[39m }
     [90m 7 |[39m 
[36mconst[39m db 
[33m=[39m admin[33m.[39mf
irestore()[33m;[39m[0m

      at Object.<anonymous> (
src/services/marketConfigServ
ice.ts:4:17)
      at Object.<anonymous> 
(src/routes/market.ts:7:1)
      at createExpressApp (sr
c/app/createExpressApp.ts:131
:24)
      at makeTestApp (tests/h
elpers/testApp.ts:10:26)
      at Object.<anonymous> (
tests/cfo-ai-report.test.ts:6
9:28)

FAIL tests/billing.test.ts
  ÔùÅ Billing ÔÇ║ reporta 
uso com sucesso

    TypeError: Cannot read 
properties of undefined 
(reading 'length')

    [0m [90m 2 |[39m 
[36mimport[39m [33m*[39m 
[36mas[39m admin 
[36mfrom[39m [32m"firebase
-admin"[39m[33m;[39m
     [90m 3 |[39m
    
[31m[1m>[22m[39m[90m 4 
|[39m [36mif[39m ([33m![
39madmin[33m.[39mapps[33m.
[39mlength) {
     [90m   |[39m          
       [31m[1m^[22m[39m
     [90m 5 |[39m   admin[
33m.[39minitializeApp()[33m
;[39m
     [90m 6 |[39m }
     [90m 7 |[39m 
[36mconst[39m db 
[33m=[39m admin[33m.[39mf
irestore()[33m;[39m[0m

      at Object.<anonymous> (
src/services/marketConfigServ
ice.ts:4:17)
      at Object.<anonymous> 
(src/routes/market.ts:7:1)
      at createExpressApp (sr
c/app/createExpressApp.ts:131
:24)
      at makeTestApp (tests/h
elpers/testApp.ts:10:26)
      at Object.<anonymous> 
(tests/billing.test.ts:22:28)

Test Suites: 6 failed, 4 
passed, 10 total
Tests:       9 failed, 5 
passed, 14 total
Snapshots:   0 total
Time:        16.578 s
Ran all test suites.
