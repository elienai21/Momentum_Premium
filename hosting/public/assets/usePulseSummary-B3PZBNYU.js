import{b as E,e as I,r as d,w as D,k as R,x as q}from"./index-sZ5pzLG8.js";function w(t,e){return e==="red"?"red":e==="yellow"&&t==="green"?"yellow":t}function C(t){let e="green";const a=[];return t.runwayMonths<2?(e=w(e,"red"),a.push("Runway abaixo de 2 meses.")):t.runwayMonths<4&&(e=w(e,"yellow"),a.push("Runway entre 2 e 4 meses.")),typeof t.marginNet=="number"&&(t.marginNet<0?(e=w(e,"red"),a.push("Margem líquida negativa.")):t.marginNet<.1&&(e=w(e,"yellow"),a.push("Margem líquida abaixo do ideal."))),t.expenseMonth>t.revenueMonth&&(e=w(e,"yellow"),a.push("Despesas maiores que a receita no período.")),{status:e,reasons:a}}async function N(t){const{tenantId:e,periodStart:a,periodEnd:u}=t,c={tenantId:e};a&&(c.start=a),u&&(c.end=u);const{data:n}=await E.get("/pulse/summary",{params:c});if(!n.ok){const v=new Error(n.error||"Erro ao carregar resumo financeiro (Pulse).");throw v.traceId=n.traceId,v}if(!n.hasData)return null;const{kpis:s,period:g,inflows:p,outflows:M,balanceSeries:y,accounts:x,alerts:r}=n,S=s.closing_balance,m=s.cash_in,b=s.cash_out,o=s.net_cash,_=typeof s.runway_days=="number"&&s.runway_days>0?s.runway_days/30:0,h=m>0?o/m:void 0,i={cashBalance:S,revenueMonth:m,expenseMonth:b,runwayMonths:_,marginNet:h},f=C(i),l=[];return f.status==="red"?l.push("Atenção: saúde financeira crítica. Revise custos fixos e fluxo de caixa imediatamente."):f.status==="yellow"?l.push("Alerta: indicadores exigem atenção. Monitore de perto despesas e entradas de caixa."):l.push("Saúde financeira estável neste período analisado."),{tenantId:n.tenantId,periodStart:g.start,periodEnd:g.end,kpis:i,inflows:p,outflows:M,balanceSeries:y,accounts:x,alerts:r,projections:n.projections,insights:l,health:f,sources:n.meta?.sources,meta:{traceId:n.meta.traceId,latency_ms:n.meta.latency_ms}}}function P(t){if(!t||!t.kpis)return!0;const{cashBalance:e,revenueMonth:a,expenseMonth:u,runwayMonths:c}=t.kpis;return[e,a,u,c].every(s=>s==null||typeof s=="number"&&Math.abs(s)<1e-5)}function j(t){return t?.response?.status??t?.status??t?.cause?.status??t?.cause?.response?.status??void 0}function B(t){const{tenantId:e,periodStart:a,periodEnd:u}=t,{user:c}=I(),[n,s]=d.useState(null),[g,p]=d.useState(!0),[M,y]=d.useState(null),[x,r]=d.useState(!1),[S,m]=d.useState(0),b=d.useCallback(()=>{m(o=>o+1)},[]);return d.useEffect(()=>{if(!c)return;if(!e){s(null),r(!0),p(!1);return}let o=!0;async function _(){p(!0),y(null),r(!1);try{const h=D(R,"tenants",e,"stats","financial_overview"),i=await q(h);if(i.exists()){const l=i.data(),v={tenantId:e,periodStart:a,periodEnd:u,kpis:{cashBalance:l.balance??0,revenueMonth:l.totalRevenue??0,expenseMonth:l.totalExpenses??0,runwayMonths:0},inflows:{total:0,byCategory:{}},outflows:{total:0,byCategory:{}},balanceSeries:[],accounts:[],alerts:[],projections:{runwayText:""},sources:["stats_cache"],meta:{traceId:"stats-cache",latency_ms:0}};if(!o)return;s(v),r(!1),p(!1);return}const f=await N({tenantId:e,periodStart:a,periodEnd:u});if(!o)return;!f||P(f)?(s(null),r(!0)):(s(f),r(!1))}catch(h){if(!o)return;const i=j(h);if(i===403||i===404){s(null),y(null),r(!0);return}y(h),s(null),r(!1)}finally{if(!o)return;p(!1)}}return _(),()=>{o=!1}},[e,a,u,S,c]),{data:n,loading:g,error:M,empty:x,refetch:b}}export{C as c,B as u};
