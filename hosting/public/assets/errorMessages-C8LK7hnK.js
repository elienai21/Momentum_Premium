import{b as _,e as I,r as f,x as N,p as R,y as D}from"./index-D_u31hn4.js";function g(e,t){return t==="red"?"red":t==="yellow"&&e==="green"?"yellow":e}function T(e){let t="green";const a=[];return e.runwayMonths<2?(t=g(t,"red"),a.push("Runway abaixo de 2 meses.")):e.runwayMonths<4&&(t=g(t,"yellow"),a.push("Runway entre 2 e 4 meses.")),typeof e.marginNet=="number"&&(e.marginNet<0?(t=g(t,"red"),a.push("Margem líquida negativa.")):e.marginNet<.1&&(t=g(t,"yellow"),a.push("Margem líquida abaixo do ideal."))),e.expenseMonth>e.revenueMonth&&(t=g(t,"yellow"),a.push("Despesas maiores que a receita no período.")),{status:t,reasons:a}}async function j(e){const{tenantId:t,periodStart:a,periodEnd:u}=e,i={tenantId:t};a&&(i.start=a),u&&(i.end=u);const{data:n}=await _.get("/pulse/summary",{params:i});if(!n.ok){const v=new Error(n.error||"Erro ao carregar resumo financeiro (Pulse).");throw v.traceId=n.traceId,v}if(!n.hasData)return null;const{kpis:s,period:w,inflows:p,outflows:b,balanceSeries:y,accounts:S,alerts:r}=n,M=s.closing_balance,h=s.cash_in,x=s.cash_out,o=s.net_cash,E=typeof s.runway_days=="number"&&s.runway_days>0?s.runway_days/30:0,m=h>0?o/h:void 0,c={cashBalance:M,revenueMonth:h,expenseMonth:x,runwayMonths:E,marginNet:m},d=T(c),l=[];return d.status==="red"?l.push("Atenção: saúde financeira crítica. Revise custos fixos e fluxo de caixa imediatamente."):d.status==="yellow"?l.push("Alerta: indicadores exigem atenção. Monitore de perto despesas e entradas de caixa."):l.push("Saúde financeira estável neste período analisado."),{tenantId:n.tenantId,periodStart:w.start,periodEnd:w.end,kpis:c,inflows:p,outflows:b,balanceSeries:y,accounts:S,alerts:r,projections:n.projections,insights:l,health:d,sources:n.meta?.sources,meta:{traceId:n.meta.traceId,latency_ms:n.meta.latency_ms}}}function q(e){if(!e||!e.kpis)return!0;const{cashBalance:t,revenueMonth:a,expenseMonth:u,runwayMonths:i}=e.kpis;return[t,a,u,i].every(s=>s==null||typeof s=="number"&&Math.abs(s)<1e-5)}function A(e){return e?.response?.status??e?.status??e?.cause?.status??e?.cause?.response?.status??void 0}function H(e){const{tenantId:t,periodStart:a,periodEnd:u}=e,{user:i}=I(),[n,s]=f.useState(null),[w,p]=f.useState(!0),[b,y]=f.useState(null),[S,r]=f.useState(!1),[M,h]=f.useState(0),x=f.useCallback(()=>{h(o=>o+1)},[]);return f.useEffect(()=>{if(!i)return;if(!t){s(null),r(!0),p(!1);return}let o=!0;async function E(){p(!0),y(null),r(!1);try{const m=N(R,"tenants",t,"stats","financial_overview"),c=await D(m);if(c.exists()){const l=c.data(),v={tenantId:t,periodStart:a,periodEnd:u,kpis:{cashBalance:l.balance??0,revenueMonth:l.totalRevenue??0,expenseMonth:l.totalExpenses??0,runwayMonths:0},inflows:{total:0,byCategory:{}},outflows:{total:0,byCategory:{}},balanceSeries:[],accounts:[],alerts:[],projections:{runwayText:""},sources:["stats_cache"],meta:{traceId:"stats-cache",latency_ms:0}};if(!o)return;s(v),r(!1),p(!1);return}const d=await j({tenantId:t,periodStart:a,periodEnd:u});if(!o)return;!d||q(d)?(s(null),r(!0)):(s(d),r(!1))}catch(m){if(!o)return;const c=A(m);if(c===403||c===404){s(null),y(null),r(!0);return}y(m),s(null),r(!1)}finally{if(!o)return;p(!1)}}return E(),()=>{o=!1}},[t,a,u,M,i]),{data:n,loading:w,error:b,empty:S,refetch:x}}function C(e){if(!e)return;const t=e?.response?.status??e?.status;if(typeof t=="number")return t}function P(e){switch(C(e)){case 401:return{title:"Sua sessão expirou",message:"Entre novamente para continuar vendo seus dados financeiros.",ctaLabel:"Fazer login",ctaHref:"/login"};case 403:return{title:"Recurso não disponível no seu plano",message:"Este recurso faz parte de um plano superior do Momentum. Veja os planos disponíveis.",ctaLabel:"Ver planos",ctaHref:"/planos"};case 404:return{title:"Nenhum dado encontrado",message:"Não encontramos dados para este período. Tente outro filtro ou importe seus dados financeiros."};case 500:return{title:"Erro inesperado",message:"Ocorreu um erro interno. Já registramos isso. Tente novamente em alguns instantes."};default:return{title:"Algo não saiu como esperado",message:"Tivemos um problema para carregar essas informações. Tente novamente. Se persistir, fale com o suporte."}}}export{T as c,P as g,H as u};
