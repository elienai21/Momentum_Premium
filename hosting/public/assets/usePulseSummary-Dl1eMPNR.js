import{a as _,f as I,r as l}from"./index-C63jyLGJ.js";function m(t,e){return e==="red"?"red":e==="yellow"&&t==="green"?"yellow":t}function q(t){let e="green";const a=[];return t.runwayMonths<2?(e=m(e,"red"),a.push("Runway abaixo de 2 meses.")):t.runwayMonths<4&&(e=m(e,"yellow"),a.push("Runway entre 2 e 4 meses.")),typeof t.marginNet=="number"&&(t.marginNet<0?(e=m(e,"red"),a.push("Margem líquida negativa.")):t.marginNet<.1&&(e=m(e,"yellow"),a.push("Margem líquida abaixo do ideal."))),t.expenseMonth>t.revenueMonth&&(e=m(e,"yellow"),a.push("Despesas maiores que a receita no período.")),{status:e,reasons:a}}async function D(t){const{tenantId:e,periodStart:a,periodEnd:c}=t,o={tenantId:e};a&&(o.start=a),c&&(o.end=c);const{data:n}=await _.get("/pulse/summary",{params:o});if(!n.ok){const b=new Error(n.error||"Erro ao carregar resumo financeiro (Pulse).");throw b.traceId=n.traceId,b}if(!n.hasData)return null;const{kpis:s,period:h,inflows:d,outflows:w,balanceSeries:f,accounts:g,alerts:u}=n,M=s.closing_balance,p=s.cash_in,v=s.cash_out,i=s.net_cash,S=typeof s.runway_days=="number"&&s.runway_days>0?s.runway_days/30:0,r=p>0?i/p:void 0,x={cashBalance:M,revenueMonth:p,expenseMonth:v,runwayMonths:S,marginNet:r},E=q(x),y=[];return E.status==="red"?y.push("Atenção: saúde financeira crítica. Revise custos fixos e fluxo de caixa imediatamente."):E.status==="yellow"?y.push("Alerta: indicadores exigem atenção. Monitore de perto despesas e entradas de caixa."):y.push("Saúde financeira estável neste período analisado."),{tenantId:n.tenantId,periodStart:h.start,periodEnd:h.end,kpis:x,inflows:d,outflows:w,balanceSeries:f,accounts:g,alerts:u,projections:n.projections,insights:y,health:E,sources:n.meta?.sources,meta:{traceId:n.meta.traceId,latency_ms:n.meta.latency_ms}}}function N(t){if(!t||!t.kpis)return!0;const{cashBalance:e,revenueMonth:a,expenseMonth:c,runwayMonths:o}=t.kpis;return[e,a,c,o].every(s=>s==null||typeof s=="number"&&Math.abs(s)<1e-5)}function A(t){const{tenantId:e,periodStart:a,periodEnd:c}=t,{user:o}=I(),[n,s]=l.useState(null),[h,d]=l.useState(!0),[w,f]=l.useState(null),[g,u]=l.useState(!1),[M,p]=l.useState(0),v=l.useCallback(()=>{p(i=>i+1)},[]);return l.useEffect(()=>{if(!o)return;if(!e){s(null),u(!0),d(!1);return}let i=!0;async function S(){d(!0),f(null),u(!1);try{const r=await D({tenantId:e,periodStart:a,periodEnd:c});if(!i)return;!r||N(r)?(s(null),u(!0)):(s(r),u(!1))}catch(r){if(!i)return;if((r?.response?.status??r?.status??r?.cause?.status??void 0)===404){s(null),f(null),u(!0);return}f(r),s(null),u(!1)}finally{if(!i)return;d(!1)}}return S(),()=>{i=!1}},[e,a,c,M,o]),{data:n,loading:h,error:w,empty:g,refetch:v}}export{q as c,A as u};
